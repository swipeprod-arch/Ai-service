<!--allrecords--> <div id="allrecords" data-tilda-export="yes" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="13172919" data-tilda-page-id="103811936" data-tilda-page-alias="add" data-tilda-formskey="77f9e6caf19eb935e0f8ff1513172919" data-tilda-cookie="no" data-tilda-lazy="yes" data-tilda-root-zone="com" data-tilda-project-headcode="yes" data-tilda-project-country="RU"> <div id="rec1689498121" class="r t-rec" style=" " data-animationappear="off" data-record-type="131"> <!-- T123 --> <div class="t123"> <div class="t-container_100 "> <div class="t-width t-width_100 "> <!-- nominify begin --> <!-- ====== /add ‚Ä¢ –∫–∞–±–∏–Ω–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (NO MODERATION) ====== --> <script>
(async function(){
  async function waitSb(){
    for(let i=0;i<40;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r => setTimeout(r,150));
    }
    return null;
  }
  const sb = await waitSb();
  if(!sb) return;

  const { data } = await sb.auth.getSession();
  const user = data?.session?.user;

  if(!user){
    const here = location.pathname + location.search + location.hash;
    location.replace("/auth?redirect=" + encodeURIComponent(here));
  }
})();
</script>
<header class="nav">
  <div class="container nav-inner">
    <a class="brand" href="/">
      <span class="logo" aria-hidden="true"></span>
      <span>AI-–ë–∏—Ä–∂–∞ (MVP)</span>
    </a>
    <nav class="nav-links" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <a href="/page103811056.html">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</a>
      <a href="/gallery.html">–ì–∞–ª–µ—Ä–µ—è —Ä–∞–±–æ—Ç</a>
      <a href="/how">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</a>
      <a href="/faq">FAQ</a>
    </nav>
    <div class="nav-cta">
      <a class="btn" href="/page103811056.html">–í –∫–∞—Ç–∞–ª–æ–≥</a>
      <a class="btn primary" href="/apply">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</a>
    </div>
  </div>
</header>

<main>
  <section class="section">
    <div class="container">
      <div class="h-card">
        <div class="h-eyebrow">–ö–∞–±–∏–Ω–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</div>
        <h1 class="h-title" style="font-size:34px;margin-bottom:8px">–ú–æ—è –∫–∞—Ä—Ç–æ—á–∫–∞</h1>
        <p class="h-sub">–ú–æ–¥–µ—Ä–∞—Ü–∏–∏ –Ω–µ—Ç: –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.</p>

        <!-- === –ë–´–°–¢–†–´–ï –î–ï–ô–°–¢–í–ò–Ø === -->
        <div class="quick-actions" id="quickActions">
          <div class="quick-status" id="cardStatus">
            <span class="status-dot"></span>
            <span class="status-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
          </div>
          <div class="quick-buttons">
            <button class="btn" id="btnViewCard" type="button" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
            </button>
            <button class="btn" id="btnCopyLink" type="button" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
              –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
            </button>
            <button class="btn" id="btnLogout" type="button" title="–í—ã–π—Ç–∏">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
              –í—ã–π—Ç–∏
            </button>
          </div>
        </div>

        <!-- === –ü–†–û–ì–†–ï–°–° –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø === -->
        <div class="profile-progress" id="profileProgress">
          <div class="progress-header">
            <span class="progress-label">–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω –Ω–∞</span>
            <span class="progress-percent" id="progressPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width:0%"></div>
          </div>
          <div class="progress-tips" id="progressTips"></div>
        </div>

        <!-- === –ü–†–ï–í–¨–Æ –ö–ê–†–¢–û–ß–ö–ò === -->
        <div class="card-preview-section" id="cardPreviewSection" style="display:none">
          <div class="preview-label">–¢–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–≤–æ—è –∫–∞—Ä—Ç–æ—á–∫–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ:</div>
          <div class="card-preview" id="cardPreview">
            <div class="preview-cover" id="previewCover">
              <div class="preview-cover-placeholder">–ù–µ—Ç –æ–±–ª–æ–∂–∫–∏</div>
            </div>
            <div class="preview-body">
              <div class="preview-name" id="previewName">–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ</div>
              <div class="preview-role" id="previewRole"></div>
              <div class="preview-short" id="previewShort">–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...</div>
              <div class="preview-meta">
                <span class="preview-price" id="previewPrice"></span>
                <span class="preview-time" id="previewTime"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- === –ê–ö–ö–û–†–î–ï–û–ù: –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ö–ê–†–¢–û–ß–ö–ò === -->
        <details class="accordion-section" id="accordionEdit" open>
          <summary class="accordion-toggle">
            <span class="accordion-icon">üìù</span>
            <span class="accordion-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</span>
            <span class="accordion-arrow">‚ñº</span>
          </summary>
          <div class="accordion-content">
            <div class="form">
              <div class="field">
                <label>–ò–º—è / –ù–∏–∫</label>
                <input id="f_name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–µ–∫—Å–µ–π" />
              </div>
              <div class="field">
                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="f_category">
                  <option value="video">AI-–í–∏–¥–µ–æ</option>
                  <option value="design">AI-–î–∏–∑–∞–π–Ω</option>
                  <option value="bots">AI-–ë–æ—Ç—ã</option>
                  <option value="marketplaces">WB/Ozon</option>
                  <option value="sites">AI-–°–∞–π—Ç—ã</option>
                </select>
              </div>
              <div class="field">
                <label>–†–æ–ª—å / —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (—Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                <input id="f_role" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: reels, –º–æ–Ω—Ç–∞–∂, —Å—É–±—Ç–∏—Ç—Ä—ã, –æ–∑–≤—É—á–∫–∞" />
                <div class="small">–ü–∏—à–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é ‚Äî –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –ø–æ–∫–∞–∂–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –ø–ª–∞—à–∫–∞–º–∏.</div>
              </div>
              <div class="field">
                <label>–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤ –ø—Ä–µ–≤—å—é –∫–∞—Ä—Ç–æ—á–∫–∏)</label>
                <textarea id="f_short" placeholder="1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –¥–µ–ª—É."></textarea>
                <div class="small">–°–æ–≤–µ—Ç: –∫–æ—Ä–æ—Ç–∫–æ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –±–µ–∑ –≤–æ–¥—ã.</div>
              </div>
              <div class="field">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ (–ø–æ–¥—Ä–æ–±–Ω–µ–µ)</label>
                <textarea id="f_desc" placeholder="–û–ø–∏—à–∏, —á—Ç–æ –¥–µ–ª–∞–µ—à—å, —Å—Ä–æ–∫–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç"></textarea>
              </div>
              <div class="two">
                <div class="field">
                  <label>–¶–µ–Ω–∞ (–ø—Ä–∏–º–µ—Ä)</label>
                  <input id="f_price" placeholder="–æ—Ç 15 000 ‚ÇΩ" />
                </div>
                <div class="field">
                  <label>–°—Ä–æ–∫ (–ø—Ä–∏–º–µ—Ä)</label>
                  <input id="f_time" placeholder="5‚Äì7 –¥–Ω–µ–π" />
                </div>
              </div>
              <div class="field">
                <label>Telegram (–¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ")</label>
                <div class="prefix-wrap">
                  <span class="prefix">@</span>
                  <input id="f_tg" placeholder="username" inputmode="text" autocomplete="off" />
                </div>
                <div class="small">–ü–∏—à–∏ —Ç–æ–ª—å–∫–æ –Ω–∏–∫. –ï—Å–ª–∏ –≤—Å—Ç–∞–≤–∏—à—å —Å—Å—ã–ª–∫—É ‚Äî —è —Å–∞–º –≤—ã—Ç–∞—â—É –Ω–∏–∫.</div>
              </div>
              <div class="two">
                <div class="field">
                  <label>Instagram</label>
                  <input id="f_ig" placeholder="@username –∏–ª–∏ https://instagram.com/username" />
                </div>
                <div class="field">
                  <label>–°–∞–π—Ç</label>
                  <input id="f_site" placeholder="site.ru –∏–ª–∏ https://site.ru" />
                </div>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
                <button class="btn primary" id="btnSave" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
              <div class="small" id="saveMsg" style="margin-top:8px"></div>
            </div>
          </div>
        </details>

        <!-- === –ê–ö–ö–û–†–î–ï–û–ù: –ú–ï–î–ò–ê === -->
        <details class="accordion-section" id="accordionMedia">
          <summary class="accordion-toggle">
            <span class="accordion-icon">üñºÔ∏è</span>
            <span class="accordion-title">–ú–µ–¥–∏–∞ (—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ)</span>
            <span class="accordion-arrow">‚ñº</span>
          </summary>
          <div class="accordion-content">
            <div class="form">
              <p class="section-sub" style="margin:0 0 10px">–ó–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –∏ –≤—ã–±–µ—Ä–∏ –ø—Ä–µ–≤—å—é –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏.</p>
              
              <!-- DRAG & DROP –ó–û–ù–ê -->
              <div class="dropzone" id="dropzone">
                <div class="dropzone-content">
                  <div class="dropzone-icon">üìÅ</div>
                  <div class="dropzone-text">–ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–∞–π–ª—ã —Å—é–¥–∞</div>
                  <div class="dropzone-or">–∏–ª–∏</div>
                  <label class="btn primary dropzone-btn">
                    –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
                    <input id="mediaInput" type="file" multiple accept="image/*,video/*" style="display:none" />
                  </label>
                  <div class="small" style="margin-top:8px">–ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ</div>
                </div>
                <div class="dropzone-active">
                  <div class="dropzone-icon-active">‚¨áÔ∏è</div>
                  <div>–û—Ç–ø—É—Å—Ç–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
                </div>
              </div>

              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
                <button class="btn primary" id="btnUpload" type="button">‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                <button class="btn" id="btnRefresh" type="button">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
              </div>
              
              <hr class="sep">
              <div class="small" style="margin-bottom:8px">–ù–∞–∂–º–∏ "–°–¥–µ–ª–∞—Ç—å –ø—Ä–µ–≤—å—é" ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–µ—Ç –æ–±–ª–æ–∂–∫–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.</div>
              <div class="media-grid" id="mediaGrid"></div>
              <div class="small" id="mediaMsg" style="margin-top:10px"></div>
            </div>
          </div>
        </details>

      </div>
    </div>
  </section>
</main> <style>
/* –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å–∏–Ω–µ–π */
.btn.primary, .btn.primary *{ color:#fff !important; -webkit-text-fill-color:#fff !important; }

.prefix-wrap{ position:relative; }
.prefix-wrap .prefix{
  position:absolute; left:14px; top:50%; transform:translateY(-50%);
  font-weight:900; opacity:.7;
}
.prefix-wrap input{ padding-left:30px !important; }

/* ============ –ë–´–°–¢–†–´–ï –î–ï–ô–°–¢–í–ò–Ø ============ */
.quick-actions{
  display:flex;
  flex-wrap:wrap;
  gap:14px;
  align-items:center;
  justify-content:space-between;
  margin:20px 0;
  padding:16px;
  border-radius:18px;
  background: linear-gradient(145deg, rgba(255,255,255,.7), rgba(231,237,247,.7));
  border:1px solid rgba(255,255,255,.8);
  box-shadow: 8px 8px 20px rgba(163,177,198,.3), -8px -8px 20px rgba(255,255,255,.9);
}
.quick-status{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:700;
}
.status-dot{
  width:12px;height:12px;
  border-radius:50%;
  background:#ccc;
  box-shadow: 0 0 8px rgba(0,0,0,.15);
  transition: background .3s, box-shadow .3s;
}
.status-dot.published{
  background: linear-gradient(135deg, #00c853, #00e676);
  box-shadow: 0 0 12px rgba(0,200,83,.5);
}
.status-dot.draft{
  background: linear-gradient(135deg, #ff9800, #ffc107);
  box-shadow: 0 0 12px rgba(255,152,0,.5);
}
.quick-buttons{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.quick-buttons .btn{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:10px 14px;
  font-size:14px;
}
.quick-buttons .btn svg{
  flex-shrink:0;
}

/* ============ –ü–†–û–ì–†–ï–°–° –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø ============ */
.profile-progress{
  margin:0 0 20px;
  padding:16px;
  border-radius:18px;
  background: linear-gradient(145deg, rgba(255,255,255,.6), rgba(231,237,247,.6));
  border:1px solid rgba(255,255,255,.75);
  box-shadow: 8px 8px 20px rgba(163,177,198,.25), -8px -8px 20px rgba(255,255,255,.9);
}
.progress-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.progress-label{
  font-size:14px;
  color:var(--muted);
}
.progress-percent{
  font-size:18px;
  font-weight:900;
  background: var(--accent-grad);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
}
.progress-bar{
  height:10px;
  border-radius:999px;
  background: rgba(163,177,198,.25);
  box-shadow: inset 4px 4px 8px rgba(163,177,198,.35), inset -4px -4px 8px rgba(255,255,255,.9);
  overflow:hidden;
}
.progress-fill{
  height:100%;
  border-radius:999px;
  background: var(--accent-grad);
  box-shadow: 0 2px 8px rgba(30,120,255,.4);
  transition: width .5s ease;
}
.progress-tips{
  margin-top:10px;
  font-size:13px;
  color:var(--muted);
}
.progress-tips ul{
  margin:6px 0 0;
  padding-left:18px;
}
.progress-tips li{
  margin:4px 0;
}

/* ============ –ü–†–ï–í–¨–Æ –ö–ê–†–¢–û–ß–ö–ò ============ */
.card-preview-section{
  margin:0 0 20px;
}
.preview-label{
  font-size:13px;
  color:var(--muted);
  margin-bottom:10px;
  font-weight:600;
}
.card-preview{
  display:flex;
  gap:16px;
  padding:16px;
  border-radius:18px;
  background: linear-gradient(145deg, #F8FBFF, #E7EDF7);
  border:1px solid rgba(255,255,255,.65);
  box-shadow: 10px 10px 24px rgba(163,177,198,.35), -10px -10px 24px rgba(255,255,255,.9);
  max-width:420px;
  transition: transform .2s, box-shadow .2s;
}
.card-preview:hover{
  transform:translateY(-2px);
  box-shadow: 14px 14px 28px rgba(163,177,198,.35), -14px -14px 28px rgba(255,255,255,.95);
}
.preview-cover{
  width:100px;
  height:100px;
  flex-shrink:0;
  border-radius:14px;
  overflow:hidden;
  background:#e0e5ec;
  display:flex;
  align-items:center;
  justify-content:center;
}
.preview-cover img, .preview-cover video{
  width:100%;height:100%;object-fit:cover;
}
.preview-cover-placeholder{
  font-size:11px;
  color:var(--muted);
  text-align:center;
  padding:8px;
}
.preview-body{
  flex:1;
  min-width:0;
}
.preview-name{
  font-size:16px;
  font-weight:900;
  color:var(--text);
  margin-bottom:4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.preview-role{
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}
.preview-role span{
  display:inline-block;
  padding:3px 8px;
  margin:2px 4px 2px 0;
  background:rgba(30,120,255,.1);
  border-radius:999px;
  font-size:11px;
}
.preview-short{
  font-size:13px;
  color:var(--text);
  line-height:1.4;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  margin-bottom:8px;
}
.preview-meta{
  display:flex;
  gap:12px;
  font-size:12px;
  color:var(--muted);
}
.preview-meta span{
  display:flex;
  align-items:center;
  gap:4px;
}

/* ============ –ê–ö–ö–û–†–î–ï–û–ù ============ */
.accordion-section{
  margin-bottom:16px;
  border-radius:var(--radius);
  background: linear-gradient(145deg, rgba(255,255,255,.5), rgba(231,237,247,.5));
  border:1px solid rgba(255,255,255,.75);
  box-shadow: 10px 10px 22px rgba(163,177,198,.3), -10px -10px 22px rgba(255,255,255,.9);
  overflow:hidden;
}
.accordion-toggle{
  width:100%;
  padding:18px 20px;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
  list-style:none;
  display:flex;
  align-items:center;
  gap:12px;
  background: linear-gradient(145deg, rgba(248,251,255,.9), rgba(231,237,247,.9));
  border:none;
  border-bottom:1px solid transparent;
  transition: background .2s, border-color .2s;
}
.accordion-toggle:hover{
  background: linear-gradient(145deg, rgba(255,255,255,1), rgba(238,243,250,1));
}
.accordion-toggle::-webkit-details-marker{
  display:none;
}
.accordion-icon{
  font-size:20px;
}
.accordion-title{
  flex:1;
  text-align:left;
  color:var(--text);
}
.accordion-arrow{
  font-size:12px;
  color:var(--muted);
  transition: transform .3s ease;
}
details[open] .accordion-toggle{
  border-bottom-color:rgba(163,177,198,.2);
}
details[open] .accordion-arrow{
  transform:rotate(180deg);
}
.accordion-content{
  padding:20px;
  animation: accordionSlide .3s ease;
}
@keyframes accordionSlide{
  from{ opacity:0; transform:translateY(-10px); }
  to{ opacity:1; transform:translateY(0); }
}

/* ============ DRAG & DROP –ó–û–ù–ê ============ */
.dropzone{
  position:relative;
  padding:30px 20px;
  border-radius:18px;
  border:2px dashed rgba(30,120,255,.35);
  background: linear-gradient(145deg, rgba(248,251,255,.7), rgba(238,243,250,.7));
  text-align:center;
  transition: border-color .2s, background .2s, transform .2s;
  cursor:pointer;
}
.dropzone:hover{
  border-color:rgba(30,120,255,.6);
  background: linear-gradient(145deg, rgba(255,255,255,.9), rgba(238,243,250,.9));
}
.dropzone.dragover{
  border-color:var(--accent1);
  background: linear-gradient(145deg, rgba(30,120,255,.08), rgba(0,183,255,.08));
  transform:scale(1.01);
}
.dropzone-content{
  transition: opacity .2s;
}
.dropzone.dragover .dropzone-content{
  opacity:0;
  pointer-events:none;
}
.dropzone-active{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:8px;
  font-size:16px;
  font-weight:700;
  color:var(--accent1);
  opacity:0;
  pointer-events:none;
  transition: opacity .2s;
}
.dropzone.dragover .dropzone-active{
  opacity:1;
}
.dropzone-icon{
  font-size:40px;
  margin-bottom:8px;
}
.dropzone-icon-active{
  font-size:48px;
  animation: bounce .5s infinite alternate;
}
@keyframes bounce{
  from{ transform:translateY(0); }
  to{ transform:translateY(-8px); }
}
.dropzone-text{
  font-size:15px;
  font-weight:600;
  color:var(--text);
}
.dropzone-or{
  font-size:13px;
  color:var(--muted);
  margin:8px 0;
}
.dropzone-btn{
  cursor:pointer;
}

/* ============ –ê–î–ê–ü–¢–ò–í ============ */
@media(max-width:720px){
  .quick-actions{
    flex-direction:column;
    align-items:stretch;
  }
  .quick-buttons{
    justify-content:center;
  }
  .card-preview{
    flex-direction:column;
    max-width:100%;
  }
  .preview-cover{
    width:100%;
    height:140px;
  }
}

/* –º–µ–¥–∏–∞ */
.media-grid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:12px;
}
@media (max-width: 720px){ .media-grid{ grid-template-columns: 1fr; } }

.media-card{
  border-radius: 16px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.7);
  background: var(--surface);
  box-shadow: 10px 10px 22px rgba(163,177,198,.25), -10px -10px 22px rgba(255,255,255,.85);
  padding:10px;
}
.media-prev{
  width:100%;
  aspect-ratio: 16/10;
  border-radius: 14px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.7);
  background: rgba(255,255,255,.35);
  margin-bottom:10px;
}
.media-prev img, .media-prev video{
  width:100%;height:100%;object-fit:cover;display:block;
}
.media-row{
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;
}
.badge2{
  font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;
  background: rgba(30,120,255,.12);border:1px solid rgba(30,120,255,.22);
  color: rgba(20,40,75,.85);
}
</style> <script>
window.addEventListener('DOMContentLoaded', async function(){
  const BUCKET = "experts-media";

  function esc(s){
    return String(s || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  async function waitSb(){
    for(let i=0;i<60;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r => setTimeout(r,150));
    }
    return null;
  }

  function normTagsCSV(s){
    const arr = String(s||"").split(",").map(x=>x.trim()).filter(Boolean);
    return arr.join(", ");
  }

  function extractUsernameFromUrl(url){
    const u = String(url||"").trim();
    const m = u.match(/(?:t\.me|telegram\.me)\/([A-Za-z0-9_]{3,})/i);
    if(m && m[1]) return m[1];
    return "";
  }

  function normTelegram(input){
    let v = String(input||"").trim();
    if(!v) return "";
    if(v.includes("t.me/") || v.includes("telegram.me/")){
      const u = extractUsernameFromUrl(v);
      if(u) return "@"+u;
    }
    v = v.replace(/^@+/, "").trim();
    v = v.replace(/\s+/g,"");
    return v ? "@"+v : "";
  }

  function normInstagram(input){
    let v = String(input||"").trim();
    if(!v) return "";
    if(/^https?:\/\//i.test(v)) return v;
    v = v.replace(/^@+/, "").trim().replace(/\s+/g,"");
    return v ? ("https://www.instagram.com/"+v+"/") : "";
  }

  function displayInstagram(v){
    v = String(v||"").trim();
    const m = v.match(/instagram\.com\/([A-Za-z0-9_.]+)/i);
    if(m && m[1]) return "@"+m[1].replace(/\/.*/,"");
    return v;
  }

  function normWebsite(input){
    let v = String(input||"").trim();
    if(!v) return "";
    if(/^https?:\/\//i.test(v)) return v;
    return "https://"+v;
  }

  function displayTelegramUsername(v){
    v = String(v||"").trim();
    if(!v) return "";
    if(v.includes("t.me/") || v.includes("telegram.me/")) {
      const u = extractUsernameFromUrl(v);
      return u || "";
    }
    return v.replace(/^@+/, "");
  }

  const sb = await waitSb();
  const saveMsg  = document.getElementById('saveMsg');
  const mediaMsg = document.getElementById('mediaMsg');
  const grid     = document.getElementById('mediaGrid');

  if(!sb){ saveMsg.textContent = "Supabase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω."; return; }

  const { data: authData } = await sb.auth.getUser();
  const user = authData?.user;
  if(!user){ saveMsg.textContent = "–¢—ã –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω. –û—Ç–∫—Ä–æ–π /auth –∏ –≤–æ–π–¥–∏."; return; }

  let myExpert = null;
  let coverUrl = null;

  // === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–†–û–ì–†–ï–°–°–ê –ò –ü–†–ï–í–¨–Æ ===
  function updateProgress(){
    const fields = [
      { id:'f_name', label:'–ò–º—è/–Ω–∏–∫', weight:20 },
      { id:'f_role', label:'–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è', weight:15 },
      { id:'f_short', label:'–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', weight:20 },
      { id:'f_desc', label:'–û–ø–∏—Å–∞–Ω–∏–µ', weight:15 },
      { id:'f_price', label:'–¶–µ–Ω–∞', weight:5 },
      { id:'f_time', label:'–°—Ä–æ–∫', weight:5 },
      { id:'f_tg', label:'Telegram', weight:15 },
    ];
    
    let filled = 0;
    let tips = [];
    
    fields.forEach(f => {
      const el = document.getElementById(f.id);
      const val = el ? el.value.trim() : '';
      if(val){
        filled += f.weight;
      } else {
        tips.push(f.label);
      }
    });
    
    // –ë–æ–Ω—É—Å –∑–∞ –æ–±–ª–æ–∂–∫—É
    if(myExpert && myExpert.cover_path){
      filled += 5;
    } else {
      tips.push('–û–±–ª–æ–∂–∫–∞ (–≤ —Ä–∞–∑–¥–µ–ª–µ –ú–µ–¥–∏–∞)');
    }
    
    filled = Math.min(100, filled);
    
    const percentEl = document.getElementById('progressPercent');
    const fillEl = document.getElementById('progressFill');
    const tipsEl = document.getElementById('progressTips');
    
    if(percentEl) percentEl.textContent = filled + '%';
    if(fillEl) fillEl.style.width = filled + '%';
    
    if(tipsEl){
      if(tips.length > 0 && filled < 100){
        tipsEl.innerHTML = '<b>–î–æ–±–∞–≤—å, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å:</b><ul>' + 
          tips.slice(0,3).map(t => '<li>' + esc(t) + '</li>').join('') + '</ul>';
      } else {
        tipsEl.innerHTML = '<b>üéâ –û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é!</b>';
      }
    }
  }

  function updatePreview(){
    const section = document.getElementById('cardPreviewSection');
    const name = document.getElementById('f_name')?.value.trim() || '';
    const role = document.getElementById('f_role')?.value.trim() || '';
    const short = document.getElementById('f_short')?.value.trim() || '';
    const price = document.getElementById('f_price')?.value.trim() || '';
    const time = document.getElementById('f_time')?.value.trim() || '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–º—è
    if(section){
      section.style.display = name ? 'block' : 'none';
    }
    
    const previewName = document.getElementById('previewName');
    const previewRole = document.getElementById('previewRole');
    const previewShort = document.getElementById('previewShort');
    const previewPrice = document.getElementById('previewPrice');
    const previewTime = document.getElementById('previewTime');
    const previewCover = document.getElementById('previewCover');
    
    if(previewName) previewName.textContent = name || '–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
    
    if(previewRole){
      const roles = role.split(',').map(r => r.trim()).filter(Boolean);
      previewRole.innerHTML = roles.length > 0 
        ? roles.slice(0,3).map(r => '<span>' + esc(r) + '</span>').join('') 
        : '';
    }
    
    if(previewShort) previewShort.textContent = short || '–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...';
    if(previewPrice) previewPrice.innerHTML = price ? 'üí∞ ' + esc(price) : '';
    if(previewTime) previewTime.innerHTML = time ? '‚è±Ô∏è ' + esc(time) : '';
    
    // –û–±–ª–æ–∂–∫–∞
    if(previewCover){
      if(coverUrl && myExpert?.cover_type){
        if(myExpert.cover_type === 'video'){
          previewCover.innerHTML = '<video src="'+esc(coverUrl)+'" muted loop playsinline autoplay></video>';
        } else {
          previewCover.innerHTML = '<img src="'+esc(coverUrl)+'" alt="">';
        }
      } else {
        previewCover.innerHTML = '<div class="preview-cover-placeholder">–ù–µ—Ç –æ–±–ª–æ–∂–∫–∏</div>';
      }
    }
  }

  function updateStatus(){
    const statusEl = document.getElementById('cardStatus');
    const dot = statusEl?.querySelector('.status-dot');
    const text = statusEl?.querySelector('.status-text');
    
    if(myExpert && myExpert.id){
      if(dot){
        dot.classList.remove('draft');
        dot.classList.add('published');
      }
      if(text) text.textContent = '‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ';
    } else {
      if(dot){
        dot.classList.remove('published');
        dot.classList.add('draft');
      }
      if(text) text.textContent = 'üìù –ß–µ—Ä–Ω–æ–≤–∏–∫ (–Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ)';
    }
  }

  // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  ['f_name','f_role','f_short','f_price','f_time','f_desc','f_tg'].forEach(id => {
    const el = document.getElementById(id);
    if(el){
      el.addEventListener('input', () => {
        updatePreview();
        updateProgress();
      });
    }
  });

  // === –ë–´–°–¢–†–´–ï –î–ï–ô–°–¢–í–ò–Ø ===
  document.getElementById('btnViewCard')?.addEventListener('click', async () => {
    if(!myExpert || !myExpert.id){
      alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É!');
      return;
    }
    window.open('/card?id=' + encodeURIComponent(myExpert.id), '_blank');
  });

  document.getElementById('btnCopyLink')?.addEventListener('click', async () => {
    if(!myExpert || !myExpert.id){
      alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É!');
      return;
    }
    const link = location.origin + '/card?id=' + encodeURIComponent(myExpert.id);
    try {
      await navigator.clipboard.writeText(link);
      const btn = document.getElementById('btnCopyLink');
      const orig = btn.innerHTML;
      btn.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      setTimeout(() => { btn.innerHTML = orig; }, 2000);
    } catch(e){
      prompt('–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É:', link);
    }
  });

  // === DRAG & DROP ===
  const dropzone = document.getElementById('dropzone');
  const mediaInput = document.getElementById('mediaInput');
  
  if(dropzone && mediaInput){
    ['dragenter','dragover'].forEach(ev => {
      dropzone.addEventListener(ev, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('dragover');
      });
    });
    
    ['dragleave','drop'].forEach(ev => {
      dropzone.addEventListener(ev, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('dragover');
      });
    });
    
    dropzone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt?.files;
      if(files && files.length > 0){
        mediaInput.files = files;
        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ drop
        uploadMedia();
      }
    });
    
    // –ö–ª–∏–∫ –Ω–∞ –∑–æ–Ω—É ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤
    dropzone.addEventListener('click', (e) => {
      if(e.target.tagName !== 'INPUT' && !e.target.closest('.dropzone-btn')){
        mediaInput.click();
      }
    });
  }

  // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
  async function loadMyCard(){
    const { data, error } = await sb
      .from("experts")
      .select("id, user_id, name, category, role, short_info, description, price_from, delivery_time, telegram, instagram, website, cover_path, cover_type, status, created_at")
      .eq("user_id", user.id)
      .order("created_at", { ascending:false })
      .limit(1);

    if(error){ saveMsg.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–∫–∏: " + error.message; return; }
    myExpert = (data && data[0]) ? data[0] : null;

    if(myExpert){
      document.getElementById('f_name').value = myExpert.name || "";
      document.getElementById('f_category').value = myExpert.category || "video";
      document.getElementById('f_role').value = myExpert.role || "";
      document.getElementById('f_short').value = myExpert.short_info || "";
      document.getElementById('f_desc').value = myExpert.description || "";
      document.getElementById('f_price').value = myExpert.price_from || "";
      document.getElementById('f_time').value = myExpert.delivery_time || "";
      document.getElementById('f_tg').value = displayTelegramUsername(myExpert.telegram || "");
      document.getElementById('f_ig').value = displayInstagram(myExpert.instagram || "");
      document.getElementById('f_site').value = myExpert.website || "";
      saveMsg.innerHTML = '–ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ‚úÖ';
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–ª–æ–∂–∫—É –¥–ª—è –ø—Ä–µ–≤—å—é
      if(myExpert.cover_path){
        const { data: urlData } = await sb.storage.from(BUCKET).createSignedUrl(myExpert.cover_path, 60*60);
        coverUrl = urlData?.signedUrl || null;
      } else {
        coverUrl = null;
      }
    } else {
      saveMsg.textContent = "–ö–∞—Ä—Ç–æ—á–∫–∏ –µ—â—ë –Ω–µ—Ç ‚Äî –∑–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.";
      coverUrl = null;
    }
    
    updateStatus();
    updateProgress();
    updatePreview();
  }

  // –∞–≤—Ç–æ–ø–æ–¥—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
  document.getElementById('f_role').addEventListener('blur', function(){
    this.value = normTagsCSV(this.value);
    updatePreview();
  });
  document.getElementById('f_tg').addEventListener('blur', function(){
    this.value = displayTelegramUsername(normTelegram(this.value));
  });
  document.getElementById('f_ig').addEventListener('blur', function(){
    const normalized = normInstagram(this.value);
    this.value = displayInstagram(normalized);
  });
  document.getElementById('f_site').addEventListener('blur', function(){
    const normalized = normWebsite(this.value);
    this.value = normalized;
  });

  async function saveCard(){
    saveMsg.textContent = "–°–æ—Ö—Ä–∞–Ω—è—é...";
    
    const payload = {
      user_id: user.id,
      name: document.getElementById('f_name').value.trim(),
      category: document.getElementById('f_category').value,
      role: normTagsCSV(document.getElementById('f_role').value),
      short_info: document.getElementById('f_short').value.trim(),
      description: document.getElementById('f_desc').value.trim(),
      price_from: document.getElementById('f_price').value.trim(),
      delivery_time: document.getElementById('f_time').value.trim(),
      telegram: normTelegram(document.getElementById('f_tg').value),
      instagram: normInstagram(document.getElementById('f_ig').value),
      website: normWebsite(document.getElementById('f_site').value),
      status: "approved"
    };

    if(!payload.name){ saveMsg.textContent = "‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏ –∏–º—è/–Ω–∏–∫."; return; }

    if(myExpert && myExpert.id){
      const { error } = await sb.from("experts").update(payload).eq("id", myExpert.id);
      if(error){ saveMsg.textContent = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + error.message; return; }
      saveMsg.textContent = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.";
    } else {
      const { data, error } = await sb.from("experts").insert(payload).select("id").single();
      if(error){ saveMsg.textContent = "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: " + error.message; return; }
      myExpert = { id: data.id, ...payload };
      saveMsg.textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ! –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ –≤–∏–¥–Ω–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.";
    }

    await loadMyCard();
    await loadMedia();
  }

  async function loadMedia(){
    grid.innerHTML = "";
    if(!myExpert || !myExpert.id){ mediaMsg.textContent = "–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É."; return; }

    mediaMsg.textContent = "–ó–∞–≥—Ä—É–∂–∞—é –º–µ–¥–∏–∞...";
    const { data, error } = await sb
      .from("expert_media")
      .select("id, media_type, storage_path, created_at")
      .eq("expert_id", myExpert.id)
      .order("created_at", { ascending:false });

    if(error){ mediaMsg.textContent = "–û—à–∏–±–∫–∞ –º–µ–¥–∏–∞: " + error.message; return; }
    if(!data || data.length===0){ mediaMsg.textContent = "–ü–æ–∫–∞ –º–µ–¥–∏–∞ –Ω–µ—Ç. –ó–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ!"; return; }

    const paths = data.map(m => m.storage_path);
    const { data: urls } = await sb.storage.from(BUCKET).createSignedUrls(paths, 60*60);
    const urlByPath = new Map();
    (urls || []).forEach(x => { if(x?.path && x?.signedUrl) urlByPath.set(x.path, x.signedUrl); });

    grid.innerHTML = data.map(m => {
      const u = urlByPath.get(m.storage_path);
      const isCover = (myExpert.cover_path && myExpert.cover_path === m.storage_path);
      return `
<div class="media-card">
  <div class="media-prev ${m.media_type==="video" ? "is-video" : ""}">
    ${m.media_type==="video"
      ? '<video src="'+u+'" controls muted playsinline preload="metadata"></video>'
      : '<img src="'+u+'" alt="">'
    }
  </div>
  <div class="media-row">
    <span class="badge2">${isCover ? "‚úÖ –û–ë–õ–û–ñ–ö–ê" : (m.media_type==="video" ? "üé¨ –í–∏–¥–µ–æ" : "üì∑ –§–æ—Ç–æ")}</span>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn ${isCover ? '' : 'primary'}" type="button" data-setcover="${esc(m.storage_path)}" data-type="${esc(m.media_type)}" ${isCover ? 'disabled' : ''}>
        ${isCover ? '–≠—Ç–æ –æ–±–ª–æ–∂–∫–∞' : '–°–¥–µ–ª–∞—Ç—å –æ–±–ª–æ–∂–∫–æ–π'}
      </button>
      <button class="btn" type="button" data-del="${esc(m.id)}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>`;
    }).join("");

    grid.querySelectorAll("[data-setcover]").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        if(btn.disabled) return;
        
        const path = btn.getAttribute("data-setcover");
        const type = btn.getAttribute("data-type");
        
        btn.textContent = "–°–æ—Ö—Ä–∞–Ω—è—é...";
        btn.disabled = true;
        
        const { error } = await sb.from("experts")
          .update({ cover_path: path, cover_type: type })
          .eq("id", myExpert.id);

        if(error){ mediaMsg.textContent = "–û—à–∏–±–∫–∞: " + error.message; return; }
        mediaMsg.textContent = "‚úÖ –û–±–ª–æ–∂–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!";
        await loadMyCard();
        await loadMedia();
      });
    });

    grid.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')) return;
        
        const mediaId = btn.getAttribute("data-del");
        btn.textContent = "–£–¥–∞–ª—è—é...";
        btn.disabled = true;

        const { data: row, error: rerr } = await sb
          .from("expert_media")
          .select("id, storage_path")
          .eq("id", mediaId)
          .single();

        if(rerr){ mediaMsg.textContent = "–û—à–∏–±–∫–∞: " + rerr.message; return; }

        await sb.storage.from(BUCKET).remove([row.storage_path]);
        const { error: derr } = await sb.from("expert_media").delete().eq("id", mediaId);
        if(derr){ mediaMsg.textContent = "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + derr.message; return; }

        if(myExpert.cover_path === row.storage_path){
          await sb.from("experts").update({ cover_path: null, cover_type: null }).eq("id", myExpert.id);
        }

        mediaMsg.textContent = "‚úÖ –£–¥–∞–ª–µ–Ω–æ!";
        await loadMyCard();
        await loadMedia();
      });
    });

    mediaMsg.textContent = "–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: " + data.length;
  }

  async function uploadMedia(){
    if(!myExpert || !myExpert.id){ 
      mediaMsg.textContent = "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É!"; 
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∞–∫–∫–æ—Ä–¥–µ–æ–Ω —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      document.getElementById('accordionEdit')?.setAttribute('open', '');
      return; 
    }

    const input = document.getElementById('mediaInput');
    const files = Array.from(input.files || []);
    if(files.length===0){ mediaMsg.textContent = "–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏."; return; }

    const btnUpload = document.getElementById('btnUpload');
    const origText = btnUpload?.innerHTML;
    if(btnUpload){
      btnUpload.disabled = true;
      btnUpload.innerHTML = "‚è≥ –ó–∞–≥—Ä—É–∂–∞—é...";
    }

    mediaMsg.textContent = "–ó–∞–≥—Ä—É–∂–∞—é " + files.length + " —Ñ–∞–π–ª(–æ–≤)...";
    
    let uploaded = 0;
    for(const file of files){
      const isVideo = file.type.startsWith("video/");
      const ext = (file.name.split(".").pop() || (isVideo ? "mp4" : "jpg")).toLowerCase();
      const path = `experts/${myExpert.id}/${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;

      const { error: uerr } = await sb.storage.from(BUCKET).upload(path, file, { upsert:false });
      if(uerr){ 
        mediaMsg.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + uerr.message; 
        if(btnUpload){ btnUpload.disabled = false; btnUpload.innerHTML = origText; }
        return; 
      }

      const { error: ierr } = await sb.from("expert_media").insert({
        user_id: user.id,
        expert_id: myExpert.id,
        media_type: isVideo ? "video" : "image",
        storage_path: path
      });

      if(ierr){ 
        mediaMsg.textContent = "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: " + ierr.message; 
        if(btnUpload){ btnUpload.disabled = false; btnUpload.innerHTML = origText; }
        return; 
      }
      
      uploaded++;
      mediaMsg.textContent = "–ó–∞–≥—Ä—É–∂–µ–Ω–æ " + uploaded + " –∏–∑ " + files.length + "...";
    }

    input.value = "";
    if(btnUpload){ btnUpload.disabled = false; btnUpload.innerHTML = origText; }
    mediaMsg.textContent = "‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ " + uploaded + " —Ñ–∞–π–ª(–æ–≤)!";
    await loadMyCard();
    await loadMedia();
  }

  document.getElementById('btnSave').addEventListener('click', saveCard);
  document.getElementById('btnUpload').addEventListener('click', uploadMedia);
  document.getElementById('btnRefresh').addEventListener('click', loadMedia);
  document.getElementById('btnLogout').addEventListener('click', async () => {
    if(confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')){
      await sb.auth.signOut();
      location.reload();
    }
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  await loadMyCard();
  await loadMedia();
  
  // –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
  updateProgress();
  updatePreview();
});
</script> <style>
/* ===== Adaptive media preview (9:16 / 16:9 / 1:1) ===== */

/* –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π 16:10 */
.media-card .media-prev{
  aspect-ratio: 16 / 9;        /* –¥–µ—Ñ–æ–ª—Ç: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ */
  height: auto !important;
  max-height: 560px;           /* —á—Ç–æ–±—ã –≤–µ—Ä—Ç–∏–∫–∞–ª–∫–∞ –Ω–µ —É—Ö–æ–¥–∏–ª–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –≤–Ω–∏–∑ */
  background: #000;            /* –∫—Ä–∞—Å–∏–≤—ã–µ –ø–æ–ª—è –¥–ª—è contain */
}

/* –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ */
.media-card .media-prev.ratio-portrait{ aspect-ratio: 9 / 16; }
.media-card .media-prev.ratio-landscape{ aspect-ratio: 16 / 9; }
.media-card .media-prev.ratio-square{ aspect-ratio: 1 / 1; }

/* –í–ê–ñ–ù–û: –ù–ï –†–ï–ñ–ï–ú */
.media-card .media-prev video,
.media-card .media-prev img{
  width: 100% !important;
  height: 100% !important;
  object-fit: contain !important; /* –Ω–µ –æ–±—Ä–µ–∑–∞–µ—Ç */
  display: block;
  background: #000;
}
</style> <script>
(function(){
  function applyRatio(prev, w, h){
    if(!w || !h) return;

    prev.classList.remove("ratio-portrait","ratio-landscape","ratio-square");

    const r = w / h;

    // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ
    if (r > 1.15){
      prev.classList.add("ratio-landscape");
      prev.style.aspectRatio = "16 / 9";
      return;
    }

    // –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ
    if (r < 0.87){
      prev.classList.add("ratio-portrait");
      prev.style.aspectRatio = "9 / 16";
      return;
    }

    // –ø–æ—á—Ç–∏ –∫–≤–∞–¥—Ä–∞—Ç
    prev.classList.add("ratio-square");
    prev.style.aspectRatio = "1 / 1";
  }

  function initPrev(prev){
    if(!prev || prev.dataset.ratioInit) return;
    prev.dataset.ratioInit = "1";

    const v = prev.querySelector("video");
    const img = prev.querySelector("img");

    if(v){
      const run = () => applyRatio(prev, v.videoWidth, v.videoHeight);
      if(v.readyState >= 1) run();
      else v.addEventListener("loadedmetadata", run, { once:true });
      return;
    }

    if(img){
      const run = () => applyRatio(prev, img.naturalWidth, img.naturalHeight);
      if(img.complete) run();
      else img.addEventListener("load", run, { once:true });
    }
  }

  function scan(){
    document.querySelectorAll(".media-card .media-prev").forEach(initPrev);
  }

  document.addEventListener("DOMContentLoaded", function(){
    scan();

    // –ª—ë–≥–∫–∏–π observer –¢–û–õ–¨–ö–û –Ω–∞ #mediaGrid (–Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç —Å–∞–π—Ç)
    const grid = document.getElementById("mediaGrid");
    if(!grid) return;

    const mo = new MutationObserver(() => scan());
    mo.observe(grid, { childList:true, subtree:true });
  });
})();
</script> <!-- FIX: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –≤–∏–¥–µ–æ –Ω–µ —Ä–µ–∂–µ–º, –¥–µ–ª–∞–µ–º 9:16 / 16:9 –∞–≤—Ç–æ --> <style>
/* –°–ò–õ–¨–ù–û–ï –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –∏–º–µ–Ω–Ω–æ –¥–ª—è –ø—Ä–µ–≤—å—é –º–µ–¥–∏–∞ */
#allrecords #mediaGrid video,
.t-records #mediaGrid video,
#allrecords .media-prev video,
.t-records .media-prev video,
#allrecords .media-preview video,
.t-records .media-preview video{
  object-fit: contain !important;
  width: 100% !important;
  height: 100% !important;
  background:#000 !important;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–µ–≤—å—é ‚Äî –ø—É—Å—Ç—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω—É–∂–Ω—ã–π ratio */
#allrecords #mediaGrid .media-prev,
.t-records #mediaGrid .media-prev,
#allrecords .media-prev,
.t-records .media-prev,
#allrecords .media-preview,
.t-records .media-preview{
  background:#000 !important;
  height:auto !important;
  max-height:560px !important;
}
</style> <script>
(function(){
  function pickRatio(w,h){
    if(!w || !h) return null;
    const r = w / h;
    if(r < 0.87) return "9 / 16";     // –≤–µ—Ä—Ç–∏–∫–∞–ª–∫–∞
    if(r > 1.15) return "16 / 9";     // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∫–∞
    return "1 / 1";                  // –ø–æ—á—Ç–∏ –∫–≤–∞–¥—Ä–∞—Ç
  }

  function applyToVideo(v){
    if(!v || v.dataset.ratioFixed) return;

    const wrap =
      v.closest(".media-prev") ||
      v.closest(".media-preview") ||
      v.parentElement;

    // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, –∏–Ω–ª–∞–π–Ω–æ–º (—Å–∞–º–æ–µ —Å–∏–ª—å–Ω–æ–µ)
    v.style.objectFit = "contain";
    v.style.width = "100%";
    v.style.height = "100%";
    v.style.background = "#000";

    function set(){
      const ratio = pickRatio(v.videoWidth, v.videoHeight);
      if(!ratio) return;

      if(wrap){
        wrap.style.aspectRatio = ratio;
        wrap.style.background = "#000";
        wrap.style.height = "auto";
        wrap.style.maxHeight = "560px";
        wrap.style.overflow = "hidden"; // —á—Ç–æ–±—ã —Ä–∞–¥–∏—É—Å –Ω–µ –ª–æ–º–∞–ª—Å—è
      }

      v.dataset.ratioFixed = "1";
    }

    // –≤–∞–∂–Ω–æ: –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –≥—Ä—É–∑–∏—Ç—å—Å—è –Ω–µ —Å—Ä–∞–∑—É
    if(v.readyState >= 1) set();
    else v.addEventListener("loadedmetadata", set, { once:true });

    // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π: –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –¥–∞–ª —Ä–∞–∑–º–µ—Ä—ã —á—É—Ç—å –ø–æ–∑–∂–µ
    setTimeout(set, 300);
    setTimeout(set, 1200);
  }

  function scan(){
    // 1) –æ—Å–Ω–æ–≤–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è –≤ –∫–∞–±–∏–Ω–µ—Ç–µ
    const grid = document.getElementById("mediaGrid");
    if(grid){
      grid.querySelectorAll("video").forEach(applyToVideo);
    }
    // 2) –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –µ—Å—Ç—å –µ—â—ë –ø—Ä–µ–≤—å—é-–≤–∏–¥–µ–æ (–æ–±–ª–æ–∂–∫–∞ –∏ —Ç.–ø.)
    document.querySelectorAll(".media-prev video, .media-preview video").forEach(applyToVideo);
  }

  document.addEventListener("DOMContentLoaded", function(){
    scan();

    // –ª—ë–≥–∫–∏–π ‚Äú–¥–æ—Å–º–æ—Ç—Ä‚Äù 3 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏ (–±–µ–∑ –ª–∞–≥–æ–≤)
    let n = 0;
    const t = setInterval(function(){
      scan();
      n++;
      if(n >= 8) clearInterval(t);
    }, 400);
  });
})();
</script> <!-- FIX: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –§–û–¢–û –Ω–µ —Ä–µ–∂–µ–º (–∫–∞–∫ Reels/Shorts) --> <style>
/* –°–ò–õ–¨–ù–û–ï –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –¥–ª—è —Ñ–æ—Ç–æ –≤ –º–µ–¥–∏–∞-–ø—Ä–µ–≤—å—é */
#allrecords #mediaGrid img,
.t-records #mediaGrid img,
#allrecords .media-prev img,
.t-records .media-prev img,
#allrecords .media-preview img,
.t-records .media-preview img{
  object-fit: contain !important;
  width: 100% !important;
  height: 100% !important;
  background:#000 !important;
}
</style> <script>
(function(){
  function pickRatio(w,h){
    if(!w || !h) return null;
    const r = w / h;
    if(r < 0.87) return "9 / 16";     // –≤–µ—Ä—Ç–∏–∫–∞–ª–∫–∞
    if(r > 1.15) return "16 / 9";     // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∫–∞
    return "1 / 1";                  // –ø–æ—á—Ç–∏ –∫–≤–∞–¥—Ä–∞—Ç
  }

  function applyToImg(img){
    if(!img || img.dataset.ratioFixed) return;

    const wrap =
      img.closest(".media-prev") ||
      img.closest(".media-preview") ||
      img.parentElement;

    // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ (–∏–Ω–ª–∞–π–Ω —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ—Ö css)
    img.style.objectFit = "contain";
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.background = "#000";

    function set(){
      const ratio = pickRatio(img.naturalWidth, img.naturalHeight);
      if(!ratio) return;

      if(wrap){
        wrap.style.aspectRatio = ratio;
        wrap.style.background = "#000";
        wrap.style.height = "auto";
        wrap.style.maxHeight = "560px";
        wrap.style.overflow = "hidden";
      }

      img.dataset.ratioFixed = "1";
    }

    if(img.complete) set();
    else img.addEventListener("load", set, { once:true });

    setTimeout(set, 300);
    setTimeout(set, 1200);
  }

  function scanImages(){
    const grid = document.getElementById("mediaGrid");
    if(grid) grid.querySelectorAll("img").forEach(applyToImg);

    document.querySelectorAll(".media-prev img, .media-preview img").forEach(applyToImg);
  }

  document.addEventListener("DOMContentLoaded", function(){
    scanImages();

    // –ª—ë–≥–∫–∏–π –¥–æ–≥–æ–Ω –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã (—á—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å –¥–æ—Ä–∏—Å–æ–≤–∫—É)
    let n=0;
    const t=setInterval(function(){
      scanImages();
      n++;
      if(n>=8) clearInterval(t);
    }, 400);
  });
})();
</script> <script>
(function(){
  const AUTH_PAGE = "/auth"; // —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ Tilda
  const BTN_TEXT = "–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ";

  function findBtnByText(txt){
    const all = Array.from(document.querySelectorAll("a,button"));
    const norm = s => (s||"").replace(/\s+/g," ").trim().toLowerCase();
    const t = norm(txt);
    return all.find(el => norm(el.textContent).includes(t)) || null;
  }

  async function waitSb(){
    for(let i=0;i<40;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r=>setTimeout(r,150));
    }
    return null;
  }

  async function isAuthed(){
    const sb = await waitSb();
    if(!sb) return false;
    const { data } = await sb.auth.getSession();
    return !!data?.session?.user;
  }

  function goAuth(){
    const redirect = encodeURIComponent(location.href);
    location.href = AUTH_PAGE + "?redirect=" + redirect;
  }

  window.addEventListener("DOMContentLoaded", async () => {
    const btn = findBtnByText(BTN_TEXT);
    if(!btn) return;

    btn.addEventListener("click", async (e) => {
      const ok = await isAuthed();
      if(!ok){
        e.preventDefault();
        e.stopPropagation();
        if(e.stopImmediatePropagation) e.stopImmediatePropagation();
        goAuth();
      }
      // –µ—Å–ª–∏ ok=true ‚Äî –∫–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ (—Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏)
    }, true);
  });
})();
</script> <style>
  /* /add: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
  #allrecords .ai-add-alert{
    margin: 0 0 14px;
    padding: 14px 16px;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,.7);
    background: rgba(255,255,255,.45);
    box-shadow: 10px 10px 22px rgba(163,177,198,.22), -10px -10px 22px rgba(255,255,255,.88);
    backdrop-filter: blur(10px);
    display:flex;
    gap:12px;
    align-items:flex-start;
    justify-content:space-between;
  }
  #allrecords .ai-add-alert b{ font-weight: 900; }
  #allrecords .ai-add-alert .x{
    width:40px;height:40px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.75);
    background: rgba(238,243,250,.85);
    box-shadow: 10px 10px 22px rgba(163,177,198,.22), -10px -10px 22px rgba(255,255,255,.88);
    cursor:pointer;
    flex:0 0 auto;
    display:flex;align-items:center;justify-content:center;
    user-select:none;
  }
  #allrecords .ai-add-alert .t{
    color: rgba(19,35,63,.78);
    line-height: 1.45;
  }
  #allrecords .ai-add-alert.info{
    border-left: 6px solid rgba(0,120,255,.55);
  }
  #allrecords .ai-add-alert.ok{
    border-left: 6px solid rgba(0,200,120,.55);
  }
</style> <script>
(function(){
  async function waitSb(){
    for(let i=0;i<40;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r => setTimeout(r,150));
    }
    return null;
  }

  function findTopAnchor(){
    // –∫—É–¥–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å –ø–ª–∞—à–∫–∏: —Å—Ç–∞—Ä–∞–µ–º—Å—è –≤ —Å–∞–º—ã–π –≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    return (
      document.querySelector('main .section .container') ||
      document.querySelector('main .container') ||
      document.querySelector('.section .container') ||
      document.querySelector('.container') ||
      document.querySelector('#allrecords') ||
      document.body
    );
  }

  function makeAlert(type, html){
    const el = document.createElement('div');
    el.className = 'ai-add-alert ' + type;
    el.innerHTML = `
      <div class="t">${html}</div> <div class="x" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</div>
    `;
    el.querySelector('.x').addEventListener('click', ()=> el.remove());
    return el;
  }

  function injectOnce(id, node, anchor){
    if(document.getElementById(id)) return;
    node.id = id;
    anchor.insertBefore(node, anchor.firstChild);
  }

  window.addEventListener('DOMContentLoaded', async () => {
    const anchor = findTopAnchor();

    // 1) –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —Å–≤–µ—Ä—Ö—É /add
    const info = makeAlert(
      'info',
      `–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ, <b>–≤–ø–∏—à–∏ –¥–∞–Ω–Ω—ã–µ –æ —Å–µ–±–µ</b> –∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É <b>¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª</b>.
      –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–∑–¥–∞—Å—Ç—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞ ‚Äî –∏ —Ç–æ–≥–¥–∞ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –º–µ–¥–∏–∞.`
    );
    injectOnce('aiAddInfoNotice', info, anchor);

    // 2) –ü–ª–∞—à–∫–∞ ‚Äú—É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥‚Äù ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –ø–æ –ø–∏—Å—å–º—É (flash –∏–∑ /auth)
    const emailFlash = (localStorage.getItem("AI_BIRZHA_LOGIN_FLASH") || "").trim();
    const ts = parseInt(localStorage.getItem("AI_BIRZHA_LOGIN_FLASH_TS") || "0", 10);
    const fresh = ts && (Date.now() - ts) < 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

    if(emailFlash && fresh){
      const ok = makeAlert('ok', `–í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –ø–æ–¥ –ª–æ–≥–∏–Ω–æ–º: <b>${emailFlash}</b>`);
      injectOnce('aiAddLoginNotice', ok, anchor);

      localStorage.removeItem("AI_BIRZHA_LOGIN_FLASH");
      localStorage.removeItem("AI_BIRZHA_LOGIN_FLASH_TS");
      return;
    }

    // 3) –ï—Å–ª–∏ flash –Ω–µ –ø—Ä–∏—à—ë–ª, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –º–æ–∂–Ω–æ —Ç–æ–∂–µ –ø–æ–∫–∞–∑–∞—Ç—å (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    const sb = await waitSb();
    if(!sb) return;

    const { data } = await sb.auth.getSession();
    const email = data?.session?.user?.email;
    if(email){
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ —Å–µ—Å—Å–∏—é –±—Ä–∞—É–∑–µ—Ä–∞
      if(!sessionStorage.getItem("AI_BIRZHA_ADD_SHOWN_AUTH")){
        const ok2 = makeAlert('ok', `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <b>${email}</b>`);
        injectOnce('aiAddLoginNotice', ok2, anchor);
        sessionStorage.setItem("AI_BIRZHA_ADD_SHOWN_AUTH", "1");
      }
    }
  });
})();
</script> <style>
  /* –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É..." —Å—Ä–∞–∑—É –ø–æ–¥ "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫" */
  #allrecords .ai-open-card-wrap{
    margin-top: 12px;
    width: 100%;
    flex-basis: 100%;
    display: flex;
    justify-content: flex-start;
  }
</style> <script>
(function(){
  async function waitSb(){
    for(let i=0;i<40;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r => setTimeout(r,150));
    }
    return null;
  }

  function findRefreshBtn(){
    const els = Array.from(document.querySelectorAll('button, a, input[type="button"], input[type="submit"]'));
    return els.find(el => {
      const t = (el.textContent || el.value || "").trim().toLowerCase();
      return t === "–æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫";
    }) || null;
  }

  window.addEventListener('DOMContentLoaded', async () => {
    const sb = await waitSb();
    if(!sb) return;

    const { data: sess } = await sb.auth.getSession();
    const uid = sess?.session?.user?.id;
    if(!uid) return; // –Ω–µ –≤–æ—à—ë–ª ‚Äî –∫–Ω–æ–ø–∫—É –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º

    const wrap = document.createElement('div');
    wrap.className = 'ai-open-card-wrap';
    wrap.innerHTML = `<button class="btn primary" type="button" id="aiOpenMyCardBtn">–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –º–æ—é –∫–∞—Ä—Ç–æ—á–∫—É</button>`;

    const refreshBtn = findRefreshBtn();
    if(refreshBtn){
      // —Å—Ç–∞–≤–∏–º –ü–†–Ø–ú–û –ø–æ–¥ "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫"
      refreshBtn.insertAdjacentElement('afterend', wrap);
    }else{
      // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –≤ –∫–æ–Ω–µ—Ü –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      (document.querySelector('#allrecords') || document.body).appendChild(wrap);
    }

    document.getElementById('aiOpenMyCardBtn').addEventListener('click', async () => {
      const { data, error } = await sb
        .from("experts")
        .select("id,created_at")
        .eq("user_id", uid)
        .order("created_at", { ascending:false })
        .limit(1);

      if(error){
        alert("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏: " + error.message);
        return;
      }
      if(!data || !data.length){
        alert("–ö–∞—Ä—Ç–æ—á–∫–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.");
        return;
      }

      window.open("/card?id=" + encodeURIComponent(data[0].id), "_blank");
    });
  });
})();
</script> <!-- ====== /add END ====== --> <!-- nominify end --> </div> </div> </div> </div> </div> <!--/allrecords-->
<style id="ai-logo-css">
  /* –õ–û–ì–û: /images/ai-logo.png + –∑–∞–ø–∞—Å–Ω–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
  .nav a.brand{
    display:flex !important;
    align-items:center !important;
    gap:10px !important;
    text-decoration:none !important;
  }
  .nav a.brand .logo{
    width: 36px !important;
    height: 36px !important;
    flex: 0 0 auto !important;
    border-radius: 999px !important;
    background:
      url("/images/ai-logo.png") center / cover no-repeat,
      linear-gradient(135deg, #1E78FF 0%, #00B7FF 100%) !important;
  }

  /* –ú–æ–±–∏–ª—å–Ω—ã–π —Ö–µ–¥–µ—Ä: –ª–æ–≥–æ—Ç–∏–ø –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω, –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å */
  @media (max-width: 560px){
    .nav a.brand{ flex: 0 0 auto !important; min-width: auto !important; }
    /* —Å–∫—Ä—ã–≤–∞–µ–º –ª—é–±–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π span –≤–Ω—É—Ç—Ä–∏ –±—Ä–µ–Ω–¥–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ .logo) */
    .nav a.brand span:not(.logo){
      display:none !important;
    }
    .nav a.brand .logo{
      width: 34px !important;
      height: 34px !important;
    }
    .nav .nav-cta{
      flex-wrap: wrap !important;
      justify-content: flex-end;
    }
  }
</style>
<script id="ai-mobile-brand-hide">
(function(){
  function apply(){
    try{
      var isMobile = window.matchMedia && window.matchMedia('(max-width: 560px)').matches;
      var nodes = document.querySelectorAll('.nav a.brand span:not(.logo)');
      nodes.forEach(function(sp){
        try{
          if(isMobile) sp.style.setProperty('display','none','important');
          else sp.style.removeProperty('display');
        }catch(e){}
      });
    }catch(e){}
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', apply);
  else apply();
  window.addEventListener('resize', apply);
  setTimeout(apply, 200);
  setTimeout(apply, 900);
})();
</script>