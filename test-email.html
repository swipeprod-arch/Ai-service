<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç Email Auth - Supabase</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 { margin-top: 0; color: #13233F; }
    h2 { color: #5B6C86; font-size: 18px; margin-top: 30px; }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    button {
      background: #0ea5e9;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover { opacity: 0.9; }
    button.secondary {
      background: #64748b;
    }
    #log {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .log-line {
      margin: 4px 0;
      padding: 4px 0;
      border-bottom: 1px solid #334155;
    }
    .log-success { color: #4ade80; }
    .log-error { color: #f87171; }
    .log-warning { color: #fbbf24; }
    .log-info { color: #60a5fa; }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    .status.ok { background: #4ade80; color: white; }
    .status.fail { background: #f87171; color: white; }
    .status.pending { background: #fbbf24; color: white; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Email Auth - Supabase</h1>
    <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ—á–µ–º—É –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–∏—Å—å–º–∞ –¥–ª—è –≤—Ö–æ–¥–∞.</p>
    
    <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase</h2>
    <button onclick="checkConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
    <span id="connectionStatus"></span>
    
    <h2>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Auth</h2>
    <button onclick="checkAuthConfig()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <span id="authStatus"></span>
    
    <h2>3. –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞</h2>
    <input type="email" id="testEmail" placeholder="–¢–≤–æ–π —Ä–µ–∞–ª—å–Ω—ã–π email" />
    <button onclick="sendTestEmail()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ</button>
    <button class="secondary" onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
  </div>
  
  <div class="card">
    <h2>üìã –õ–æ–≥–∏</h2>
    <div id="log"></div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://orxzpefskbkcyuoobkol.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_fj9X3SDLjXiL0v3pajtMwA_fTYhN3us";
    
    let sb;
    const logDiv = document.getElementById('log');
    
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.className = `log-line log-${type}`;
      div.textContent = `[${time}] ${message}`;
      logDiv.appendChild(div);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }
    
    function clearLog() {
      logDiv.innerHTML = '';
    }
    
    function setStatus(elementId, text, status) {
      const el = document.getElementById(elementId);
      el.innerHTML = `<span class="status ${status}">${text}</span>`;
    }
    
    async function checkConnection() {
      log('üîç –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase...', 'info');
      
      try {
        if (!window.supabase) {
          log('‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'error');
          setStatus('connectionStatus', '–û–®–ò–ë–ö–ê', 'fail');
          return;
        }
        
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        log('‚úÖ Supabase –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω', 'success');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API
        const { data, error } = await sb.auth.getSession();
        
        if (error) {
          log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
          setStatus('connectionStatus', '–û–®–ò–ë–ö–ê', 'fail');
        } else {
          log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'success');
          log(`üìä URL: ${SUPABASE_URL}`, 'info');
          setStatus('connectionStatus', 'OK', 'ok');
        }
      } catch (e) {
        log(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${e.message}`, 'error');
        setStatus('connectionStatus', '–û–®–ò–ë–ö–ê', 'fail');
      }
    }
    
    async function checkAuthConfig() {
      log('üîç –ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Auth...', 'info');
      
      if (!sb) {
        log('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ!', 'warning');
        setStatus('authStatus', '–ü–†–û–ü–£–©–ï–ù–û', 'pending');
        return;
      }
      
      try {
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é
        const { data: sessionData } = await sb.auth.getSession();
        log(`‚úÖ Auth API –¥–æ—Å—Ç—É–ø–µ–Ω`, 'success');
        
        if (sessionData?.session) {
          log(`‚úÖ –ï—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è: ${sessionData.session.user.email}`, 'success');
        } else {
          log(`‚ÑπÔ∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞)`, 'info');
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–µ endpoint'—ã
        log('‚ÑπÔ∏è –ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Email Auth...', 'info');
        
        setStatus('authStatus', 'OK', 'ok');
        
        log('‚ö†Ô∏è –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—å –≤ Supabase Dashboard:', 'warning');
        log('   1. Authentication ‚Üí Providers ‚Üí Email', 'warning');
        log('   2. –£–±–µ–¥–∏—Å—å —á—Ç–æ "Enable Email provider" –≤–∫–ª—é—á–µ–Ω', 'warning');
        log('   3. –ü—Ä–æ–≤–µ—Ä—å Email Templates ‚Üí Magic Link', 'warning');
        
      } catch (e) {
        log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${e.message}`, 'error');
        setStatus('authStatus', '–û–®–ò–ë–ö–ê', 'fail');
      }
    }
    
    async function sendTestEmail() {
      const email = document.getElementById('testEmail').value.trim();
      
      if (!email) {
        log('‚ö†Ô∏è –í–≤–µ–¥–∏ email!', 'warning');
        return;
      }
      
      if (!sb) {
        log('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ!', 'warning');
        return;
      }
      
      log(`üìß –û—Ç–ø—Ä–∞–≤–ª—è—é —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ –Ω–∞: ${email}`, 'info');
      
      try {
        const { data, error } = await sb.auth.signInWithOtp({
          email,
          options: {
            emailRedirectTo: window.location.origin
            // –£–±—Ä–∞–ª–∏ shouldCreateUser - —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          }
        });
        
        if (error) {
          log(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
          
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
          if (error.message.includes('rate limit')) {
            log('‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–¥–æ–∂–¥–∏ 60 —Å–µ–∫—É–Ω–¥.', 'warning');
          } else if (error.message.includes('invalid')) {
            log('‚ö†Ô∏è Email –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π. –ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∞–ª—å–Ω—ã–π email.', 'warning');
          } else if (error.message.includes('not authorized')) {
            log('‚ö†Ô∏è Email Auth –Ω–µ –≤–∫–ª—é—á–µ–Ω –≤ Supabase!', 'error');
            log('   ‚Üí –û—Ç–∫—Ä–æ–π: Dashboard ‚Üí Authentication ‚Üí Providers', 'error');
            log('   ‚Üí –í–∫–ª—é—á–∏: "Enable Email provider"', 'error');
          } else if (error.message.includes('SMTP')) {
            log('‚ö†Ô∏è SMTP –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!', 'error');
            log('   ‚Üí –û—Ç–∫—Ä–æ–π: Dashboard ‚Üí Project Settings ‚Üí Auth', 'error');
            log('   ‚Üí –ù–∞—Å—Ç—Ä–æ–π SMTP –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π', 'error');
          }
        } else {
          log(`‚úÖ –£–°–ü–ï–•! –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!`, 'success');
          log(`‚ÑπÔ∏è –ü—Ä–æ–≤–µ—Ä—å –ø–æ—á—Ç—É: ${email}`, 'info');
          log(`‚ÑπÔ∏è –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—å –ø–∞–ø–∫—É "–°–ø–∞–º"`, 'info');
          
          if (data) {
            log(`üìä Data: ${JSON.stringify(data)}`, 'info');
          }
        }
      } catch (e) {
        log(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${e.message}`, 'error');
      }
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', () => {
      log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞—á–∏–Ω–∞—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É...', 'info');
      setTimeout(checkConnection, 500);
    });
  </script>
</body>
</html>

