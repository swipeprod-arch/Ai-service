<!DOCTYPE html> <html> <head> <meta charset="utf-8" /> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!--metatextblock--> <title>add</title> <meta property="og:url" content="http://project13172919.tilda.ws/add" /> <meta property="og:title" content="add" /> <meta property="og:description" content="" /> <meta property="og:type" content="website" /> <link rel="canonical" href="http://project13172919.tilda.ws/add"> <!--/metatextblock--> <meta name="format-detection" content="telephone=no" /> <meta http-equiv="x-dns-prefetch-control" content="on"> <link rel="dns-prefetch" href="https://ws.tildacdn.com"> <link rel="dns-prefetch" href="https://static.tildacdn.com"> <link rel="shortcut icon" href="https://static.tildacdn.com/img/tildafavicon.ico" type="image/x-icon" /> <!-- Assets --> <script src="https://neo.tildacdn.com/js/tilda-fallback-1.0.min.js" async charset="utf-8"></script> <link rel="stylesheet" href="https://static.tildacdn.com/css/tilda-grid-3.0.min.css" type="text/css" media="all" onerror="this.loaderr='y';"/> <link rel="stylesheet" href="https://static.tildacdn.com/ws/project13172919/tilda-blocks-page103811936.min.css?t=1765892010" type="text/css" media="all" onerror="this.loaderr='y';" /> <link rel="stylesheet" type="text/css" href="/custom.css?t=1765892010"> <link rel="stylesheet" href="https://static.tildacdn.com/css/fonts-tildasans.css" type="text/css" media="all" onerror="this.loaderr='y';" /> <script nomodule src="https://static.tildacdn.com/js/tilda-polyfill-1.0.min.js" charset="utf-8"></script> <script type="text/javascript">function t_onReady(func) {if(document.readyState!='loading') {func();} else {document.addEventListener('DOMContentLoaded',func);}}
function t_onFuncLoad(funcName,okFunc,time) {if(typeof window[funcName]==='function') {okFunc();} else {setTimeout(function() {t_onFuncLoad(funcName,okFunc,time);},(time||100));}}</script> <script src="https://static.tildacdn.com/js/jquery-1.10.2.min.js" charset="utf-8" onerror="this.loaderr='y';"></script> <script src="https://static.tildacdn.com/js/tilda-scripts-3.0.min.js" charset="utf-8" defer onerror="this.loaderr='y';"></script> <script src="https://static.tildacdn.com/ws/project13172919/tilda-blocks-page103811936.min.js?t=1765892010" charset="utf-8" async onerror="this.loaderr='y';"></script> <script src="https://static.tildacdn.com/js/tilda-lazyload-1.0.min.js" charset="utf-8" async onerror="this.loaderr='y';"></script> <script src="https://static.tildacdn.com/js/tilda-events-1.0.min.js" charset="utf-8" async onerror="this.loaderr='y';"></script> <!-- nominify begin --><script>
window.AI_BIRZHA = {
  SUPABASE_URL: "https://orxzpefskbkcyuoobkol.supabase.co",
  SUPABASE_ANON_KEY: "sb_publishable_fj9X3SDLjXiL0v3pajtMwA_fTYhN3us",

  // ====== –ù–ê–°–¢–†–û–ô–ö–ò URL (–ò–ó–ú–ï–ù–ò –ó–î–ï–°–¨) ======
  // –õ–æ–∫–∞–ª—å–Ω—ã–π URL (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
  LOCAL_URL: "http://project13172919-.test",
  
  // –ü—Ä–æ–¥–∞–∫—à–Ω URL (–¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Å–∞–π—Ç–∞)
  PRODUCTION_URL: "https://e45318ft.beget.tech",  // ‚Üê —Ç–≤–æ–π –¥–æ–º–µ–Ω –Ω–∞ Beget
  
  // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ —Ä—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
  // –í–∞—Ä–∏–∞–Ω—Ç—ã: "auto" (–∞–≤—Ç–æ), "local" (–≤—Å–µ–≥–¥–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π), "production" (–≤—Å–µ–≥–¥–∞ –ø—Ä–æ–¥–∞–∫—à–Ω)
  ENVIRONMENT: "auto",
  // =========================================

  AUTH_PATH: "/auth",
  APPLY_PATH: "/apply",
  ADD_PATH: "/add",
  EXPERTS_PATH: "/experts"
};

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ PUBLIC_ORIGIN
(function() {
  const config = window.AI_BIRZHA;
  
  if (config.ENVIRONMENT === "auto") {
    // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ –≤ URL –µ—Å—Ç—å localhost, .test, 127.0.0.1 ‚Üí –ª–æ–∫–∞–ª—å–Ω—ã–π
    const isLocal = /localhost|\.test|127\.0\.0\.1/.test(location.hostname);
    config.PUBLIC_ORIGIN = isLocal ? config.LOCAL_URL : config.PRODUCTION_URL;
  } else if (config.ENVIRONMENT === "local") {
    config.PUBLIC_ORIGIN = config.LOCAL_URL;
  } else if (config.ENVIRONMENT === "production") {
    config.PUBLIC_ORIGIN = config.PRODUCTION_URL;
  } else {
    // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π origin
    config.PUBLIC_ORIGIN = location.origin;
  }
  
  console.log('üåç –û–∫—Ä—É–∂–µ–Ω–∏–µ:', config.ENVIRONMENT === "auto" ? (config.PUBLIC_ORIGIN === config.LOCAL_URL ? "LOCAL" : "PRODUCTION") : config.ENVIRONMENT.toUpperCase());
  console.log('üîó PUBLIC_ORIGIN:', config.PUBLIC_ORIGIN);
})();
</script> <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> <script>
(function initSupabase(){
  function tryInit(){
    if(!window.AI_BIRZHA) return;

    // —É–∂–µ —Å–æ–∑–¥–∞–Ω–æ
    if(window.AI_BIRZHA.sb) return;

    // –∂–¥—ë–º –∑–∞–≥—Ä—É–∑–∫—É –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ supabase-js
    if(window.supabase && typeof window.supabase.createClient === "function"){
      window.AI_BIRZHA.sb = window.supabase.createClient(
        window.AI_BIRZHA.SUPABASE_URL,
        window.AI_BIRZHA.SUPABASE_ANON_KEY
      );
      return;
    }

    setTimeout(tryInit, 80);
  }
  tryInit();
})();
</script> <style>
/* ====== AI-–ë–∏—Ä–∂–∞ ‚Ä¢ Neumorphism Light Theme ====== */
:root{
  --bg:#EEF3FA;
  --surface:#EEF3FA;
  --surface2:#F6F9FF;

  --text:#13233F;
  --muted:#5B6C86;

  --radius:22px;
  --radius-sm:16px;
  --max:1120px;

  --shadow-dark: rgba(163,177,198,.55);
  --shadow-light: rgba(255,255,255,.92);

  --stroke: rgba(255,255,255,.65);

  /* –°–∏–Ω–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –∫–∞–∫ –≤ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–µ */
  --accent1:#1E78FF;
  --accent2:#00B7FF;
  --accent-grad: linear-gradient(135deg, var(--accent1) 0%, var(--accent2) 100%);
}

/* –±–∞–∑–∞ */
*{box-sizing:border-box}
html,body{
  margin:0;padding:0;
  background: radial-gradient(1200px 700px at 15% -10%, rgba(30,120,255,.18), transparent 60%),
              radial-gradient(900px 600px at 90% 0%, rgba(0,183,255,.12), transparent 55%),
              var(--bg) !important;
  color:var(--text) !important;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
}
img{max-width:100%;display:block}
a{color:inherit;text-decoration:none}

/* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
.container{max-width:var(--max);margin:0 auto;padding:0 18px}

/* –Ω–∞–≤–±–∞—Ä */
.nav{
  position:sticky;top:0;z-index:50;
  background: rgba(238,243,250,.75) !important;
  backdrop-filter: blur(14px);
  border-bottom: 1px solid rgba(255,255,255,.55);
  box-shadow: 10px 10px 22px rgba(163,177,198,.35);
}
.nav-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 0;}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
.logo{
  width:34px;height:34px;border-radius:14px;
  background: var(--accent-grad);
  box-shadow: 10px 10px 20px rgba(163,177,198,.45), -10px -10px 20px rgba(255,255,255,.85);
}
.nav-links{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.nav-links a{
  padding:10px 12px;border-radius:16px;
  color:var(--muted) !important;
  background: transparent;
}
.nav-links a:hover{
  color:var(--text) !important;
  background: var(--surface);
  box-shadow: 8px 8px 18px rgba(163,177,198,.35), -8px -8px 18px rgba(255,255,255,.9);
}

/* –∫–Ω–æ–ø–∫–∏ */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:10px;
  padding:12px 16px;border-radius:18px;
  border:1px solid var(--stroke);
  background: var(--surface);
  color:var(--text);
  cursor:pointer;
  transition: .15s transform ease, .15s box-shadow ease, .15s filter ease;
  box-shadow: 10px 10px 22px rgba(163,177,198,.45), -10px -10px 22px rgba(255,255,255,.9);
}
.btn:hover{transform: translateY(-1px); filter:saturate(1.05)}
.btn:active{
  transform: translateY(0);
  box-shadow: inset 10px 10px 22px rgba(163,177,198,.45), inset -10px -10px 22px rgba(255,255,255,.9);
}
.btn.primary{
  background: var(--accent-grad);
  border-color: rgba(30,120,255,.18);
  color:#fff;
  box-shadow: 12px 12px 26px rgba(30,120,255,.28), -10px -10px 22px rgba(255,255,255,.75);
}
.btn.primary:hover{filter:saturate(1.1) brightness(1.02)}
.btn.green{ /* –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –æ—Å—Ç–∞–ª–∞—Å—å –∑–µ–ª—ë–Ω–∞—è ‚Äî –¥–µ–ª–∞–µ–º –µ—ë –ø—Ä–æ—Å—Ç–æ "–∞–∫—Ü–µ–Ω—Ç–Ω–æ–π" */
  background: var(--accent-grad);
  border-color: rgba(0,183,255,.18);
  color:#fff;
}

/* hero */
.hero{padding:56px 0 26px}
.hero-grid{display:grid;grid-template-columns: 1.25fr .75fr; gap:20px; align-items:stretch}
@media (max-width: 900px){.hero-grid{grid-template-columns:1fr} .nav-links{display:none}}

/* –∫–∞—Ä—Ç–æ—á–∫–∏ */
.h-card,
.card{
  background: linear-gradient(145deg, #F8FBFF, #E7EDF7) !important;
  border:1px solid rgba(255,255,255,.65);
  border-radius: var(--radius);
  box-shadow: 14px 14px 28px rgba(163,177,198,.45), -14px -14px 28px rgba(255,255,255,.92);
}
.h-card{padding:26px}
.card{padding:16px;transition:.15s transform ease, .15s box-shadow ease}
.card:hover{
  transform: translateY(-2px);
  box-shadow: 18px 18px 34px rgba(163,177,198,.42), -18px -18px 34px rgba(255,255,255,.94);
}

/* –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
.h-eyebrow{color:var(--muted);font-weight:700;letter-spacing:.2px}
.h-title{
  font-size:40px;line-height:1.05;margin:10px 0 12px;font-weight:900;
  background: var(--accent-grad);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
}
@media (max-width: 520px){.h-title{font-size:34px}}
.section-title{
  font-size:22px;margin:0 0 12px;font-weight:900;
  background: var(--accent-grad);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
}
.h-sub,.section-sub{color:var(--muted);line-height:1.55}
.card h3{margin:0 0 8px;font-size:18px;color:var(--text)}
.card p{margin:0 0 12px;color:var(--muted);line-height:1.55}

/* –ø–æ–∏—Å–∫ + –∏–Ω–ø—É—Ç—ã (–≤–¥–∞–≤–ª–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç) */
.searchbox{
  display:flex;gap:10px;flex-wrap:wrap;
  padding:12px;border-radius: 20px;
  background: var(--surface);
  border:1px solid rgba(255,255,255,.7);
  box-shadow: inset 10px 10px 22px rgba(163,177,198,.45), inset -10px -10px 22px rgba(255,255,255,.92);
}
.searchbox input,
input,select,textarea{
  width:100%;
  padding:12px 12px;border-radius:16px;
  border:1px solid rgba(255,255,255,.7);
  background: var(--surface);
  color: var(--text);
  outline:none;
  box-shadow: inset 10px 10px 22px rgba(163,177,198,.40), inset -10px -10px 22px rgba(255,255,255,.92);
}
.searchbox input::placeholder{color: rgba(91,108,134,.8)}
label{font-size:13px;color:var(--muted)}

/* —Ç–µ–≥–∏/–ø–ª–∞—à–∫–∏ */
.tag{
  font-size:12px;
  color: var(--muted);
  padding:7px 12px;border-radius:999px;
  border:1px solid rgba(255,255,255,.7);
  background: var(--surface);
  box-shadow: inset 8px 8px 18px rgba(163,177,198,.30), inset -8px -8px 18px rgba(255,255,255,.92);
}
.tagrow{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 0}

/* KPI */
.kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi{
  flex:1 1 150px;
  border-radius:18px;
  padding:12px;
  border:1px solid rgba(255,255,255,.7);
  background: var(--surface);
  box-shadow: inset 10px 10px 22px rgba(163,177,198,.35), inset -10px -10px 22px rgba(255,255,255,.92);
}
.kpi .n{font-weight:900;font-size:18px;color:var(--text)}
.kpi .t{color:var(--muted);font-size:12px;margin-top:2px}

/* —Ä–∞–∑–¥–µ–ª—ã */
.section{padding:26px 0}
.grid{display:grid;gap:14px;grid-template-columns: repeat(3, minmax(0, 1fr));}
@media (max-width: 900px){.grid{grid-template-columns: repeat(2, minmax(0, 1fr));}}
@media (max-width: 560px){.grid{grid-template-columns: 1fr;}}
.list{margin:0;padding-left:16px;color:var(--muted);line-height:1.6}
hr.sep{border:none;border-top:1px solid rgba(163,177,198,.35);margin:18px 0}

/* —Ñ—É—Ç–µ—Ä */
.footer{
  padding:34px 0;
  color:var(--muted);
  border-top:1px solid rgba(163,177,198,.35);
  margin-top:34px;
}
.footer a{color:var(--muted)}
.footer a:hover{color:var(--text)}
.foot-grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:16px}
@media (max-width: 820px){.foot-grid{grid-template-columns:1fr}}

/* badges */
.badge{
  display:inline-flex;gap:8px;align-items:center;
  font-size:12px;font-weight:900;
  padding:7px 12px;border-radius:999px;
  background: var(--surface);
  color: var(--text);
  border:1px solid rgba(255,255,255,.75);
  box-shadow: 10px 10px 22px rgba(163,177,198,.35), -10px -10px 22px rgba(255,255,255,.92);
}
.badge.purple{
  background: var(--accent-grad);
  color:#fff;
  border-color: rgba(30,120,255,.18);
}

/* FIX: —á—Ç–æ–±—ã Tilda –Ω–µ –ø–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞–ª–∞ —Å—Å—ã–ª–∫–∏ */
#allrecords a,
#allrecords a:visited,
.t-records a,
.t-records a:visited{
  color: inherit !important;
  text-decoration: none !important;
}
</style> <script>
window.addEventListener('DOMContentLoaded', function () {

  /* 1) –ê–≤—Ç–æ-—Ñ–∏–∫—Å —Å—Å—ã–ª–æ–∫: /services.html -> /services */
  document.querySelectorAll('a[href]').forEach(function(a){
    let href = a.getAttribute('href');
    if(!href) return;

    // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å—Å—ã–ª–∫–∏
    if (
      href.startsWith('http') ||
      href.startsWith('mailto:') ||
      href.startsWith('tel:') ||
      href.startsWith('#')
    ) return;

    // –¥–µ–ª–∞–µ–º —Å—Å—ã–ª–∫—É –∞–±—Å–æ–ª—é—Ç–Ω–æ–π (—á—Ç–æ–±—ã "services.html" —Ç–æ–∂–µ –ø–æ–π–º–∞—Ç—å)
    if (!href.startsWith('/')) href = '/' + href;

    // —Ä–µ–∂–µ–º .html
    if (href.endsWith('.html')) href = href.slice(0, -5);

    // index.html -> /
    if (href === '/index') href = '/';

    a.setAttribute('href', href);
  });

  /* 2) –ù–∞—Å—Ç—Ä–æ–π –∞–¥—Ä–µ—Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞—è–≤–∫–∏ (–µ—Å–ª–∏ —É —Ç–µ–±—è –Ω–µ /apply ‚Äî –ø–æ–º–µ–Ω—è–π) */
  const APPLY_PATH = '/apply';

  /* 3) –ü–æ–∏—Å–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π: –≤–µ–¥—ë—Ç –Ω–∞ –∑–∞—è–≤–∫—É –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç */
  const sform = document.querySelector('form[data-search]');
  if (sform) {
    sform.addEventListener('submit', function (e) {
      e.preventDefault();
      const input = sform.querySelector('input[name="q"]');
      const q = input ? input.value.trim() : '';
      location.href = APPLY_PATH + '?q=' + encodeURIComponent(q);
    });
  }

  /* 4) –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º */
  const qs = new URLSearchParams(location.search);
  const setVal = (id, v) => { const el = document.getElementById(id); if(el && v) el.value = v; };
  setVal('req_text', qs.get('q'));
  setVal('category', qs.get('cat'));
  setVal('expert', qs.get('expert'));

  /* 5) –î–µ–º–æ-–æ—Ç–ø—Ä–∞–≤–∫–∞ (–ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª —Ñ–æ—Ä–º—ã) */
  const form = document.querySelector('form[data-static-submit]');
  if (form) {
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      alert('–î–µ–º–æ: —Ñ–æ—Ä–º–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞. –ü–æ–¥–∫–ª—é—á–∏ –≤ Tilda –∫ –ø–æ—á—Ç–µ/CRM/Telegram.');
    });
  }

});
</script> <style>
.pick-grid{
  display:grid;
  grid-template-columns: repeat(6, minmax(0, 1fr));
  gap:12px;
  margin-top:12px;
}
@media (max-width: 980px){ .pick-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
@media (max-width: 560px){ .pick-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }

.pick-btn{
  width:100%;
  border:1px solid rgba(255,255,255,.75);
  border-radius:18px;
  padding:14px 12px;
  background: var(--surface);
  color: var(--text);
  font-weight:900;
  cursor:pointer;
  box-shadow: 10px 10px 22px rgba(163,177,198,.45), -10px -10px 22px rgba(255,255,255,.92);
  transition: .15s transform ease, .15s box-shadow ease, .15s filter ease;
}
.pick-btn:hover{ transform: translateY(-1px); filter:saturate(1.05); }
.pick-btn:active{
  transform: translateY(0);
  box-shadow: inset 10px 10px 22px rgba(163,177,198,.45), inset -10px -10px 22px rgba(255,255,255,.92);
}
.pick-btn.active{
  background: var(--accent-grad);
  color:#fff;
  border-color: rgba(30,120,255,.18);
  box-shadow: 12px 12px 26px rgba(30,120,255,.25), -10px -10px 22px rgba(255,255,255,.75);
}
.pick-btn.ghost{ opacity:.85; }
</style> <script>
window.addEventListener('DOMContentLoaded', function () {

  function applyCat(cat){
    const buttons = document.querySelectorAll('.cat-picker [data-cat]');
    const cards = document.querySelectorAll('[data-expert-card]');

    buttons.forEach(function(b){
      b.classList.toggle('active', !!cat && b.dataset.cat === cat);
    });

    cards.forEach(function(c){
      const ok = !cat || c.dataset.cat === cat;
      c.style.display = ok ? '' : 'none';
    });

    // –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ URL ?cat=..., —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π
    const u = new URL(window.location.href);
    if(cat) u.searchParams.set('cat', cat);
    else u.searchParams.delete('cat');
    history.replaceState(null, '', u.toString());
  }

  // –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–∞–º
  document.querySelectorAll('.cat-picker [data-cat]').forEach(function(btn){
    btn.addEventListener('click', function(){
      applyCat(btn.dataset.cat || '');
    });
  });

  // –∞–≤—Ç–æ–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑ URL
  const qs = new URLSearchParams(location.search);
  applyCat(qs.get('cat') || '');

});
</script> <style>
/* 1) –í—Å–µ–≥–¥–∞ –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å–∏–Ω–µ–π –∫–Ω–æ–ø–∫–µ –≤ —à–∞–ø–∫–µ */
#allrecords .nav .btn.primary,
#allrecords .nav .btn.primary *,
.t-records .nav .btn.primary,
.t-records .nav .btn.primary *{
  color:#fff !important;
}
</style> <script>
(async function () {
  // –ù–∞—Ö–æ–¥–∏–º —Å–∏–Ω—é—é –∫–Ω–æ–ø–∫—É –≤ —à–∞–ø–∫–µ (—Ç–∞–º –≥–¥–µ —Ä–∞–Ω—å—à–µ "–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É")
  function findHeaderPrimaryBtn(){
    const nav = document.querySelector('.nav');
    if(!nav) return null;
    return nav.querySelector('.nav-cta .btn.primary') || nav.querySelector('.btn.primary');
  }

  // –ñ–¥—ë–º, –ø–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è Supabase (window.AI_BIRZHA.sb)
  async function waitSupabase(){
    for(let i=0;i<50;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r => setTimeout(r,120));
    }
    return null;
  }

  const btn = findHeaderPrimaryBtn();
  if(!btn) return;

  // –î–µ—Ñ–æ–ª—Ç (–µ—Å–ª–∏ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω –∏–ª–∏ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏)
  function setPortfolio(){
    btn.textContent = '–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ';
    btn.setAttribute('href', '/add');   // —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏/–∫–∞–±–∏–Ω–µ—Ç–∞
    btn.classList.add('primary');
    btn.style.color = '#fff';
  }

  // –ï—Å–ª–∏ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω –∏ –∫–∞—Ä—Ç–æ—á–∫–∞ —É–∂–µ –µ—Å—Ç—å
  function setCabinet(){
    btn.textContent = '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç';
    btn.setAttribute('href', '/add');   // –∫–∞–±–∏–Ω–µ—Ç (—É —Ç–µ–±—è –æ–Ω –Ω–∞ /add)
    btn.classList.add('primary');
    btn.style.color = '#fff';
  }

  setPortfolio();

  const sb = await waitSupabase();
  if(!sb) return;

  const { data: authData } = await sb.auth.getUser();
  const user = authData?.user;

  // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º "–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ"
  if(!user) return;

  // –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ (experts.user_id = user.id)
  try{
    const { data, error } = await sb
      .from('experts')
      .select('id')
      .eq('user_id', user.id)
      .limit(1);

    if(!error && data && data.length > 0){
      setCabinet();
    } else {
      setPortfolio();
    }
  } catch(e){
    // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –ø—É—Å—Ç—å –±—É–¥–µ—Ç –∫–∞–±–∏–Ω–µ—Ç
    setCabinet();
  }
})();
</script> <style>
/* –ñ—ë—Å—Ç–∫–æ –¥–µ–ª–∞–µ–º –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å–∏–Ω–µ–π –∫–Ω–æ–ø–∫–µ –≤ —à–∞–ø–∫–µ (–æ–±—Ö–æ–¥–∏—Ç —Ç–≤–æ–π #allrecords a {color:inherit!important}) */
#allrecords .nav .nav-cta a.ai-cta,
#allrecords .nav .nav-cta a.ai-cta:visited,
#allrecords .nav .nav-cta a.ai-cta *,
#allrecords .nav a.ai-cta,
#allrecords .nav a.ai-cta *{
  color:#fff !important;
  -webkit-text-fill-color:#fff !important;
}
</style> <script>
(function(){
  const ADD_PATH   = (window.AI_BIRZHA && window.AI_BIRZHA.ADD_PATH) ? window.AI_BIRZHA.ADD_PATH : "/add";
  const APPLY_PATH = (window.AI_BIRZHA && window.AI_BIRZHA.APPLY_PATH) ? window.AI_BIRZHA.APPLY_PATH : "/apply";

  function cleanHref(h){
    if(!h) return "";
    return String(h)
      .replace(location.origin, "")
      .replace(/\.html(?=($|\?|\#))/, "");
  }

  function findHeaderBtn(){
    const nav = document.querySelector(".nav") || document.querySelector("header");
    if(!nav) return null;

    const links = Array.from(nav.querySelectorAll("a"));

    // 1) —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ /apply (—Å—Ç–∞—Ä–∞—è –∫–Ω–æ–ø–∫–∞)
    let btn = links.find(a => cleanHref(a.getAttribute("href")).startsWith(APPLY_PATH));

    // 2) –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏—â–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É "–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É"
    if(!btn) btn = links.find(a => (a.textContent || "").trim().toLowerCase() === "–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É");

    // 3) –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–Ω–æ–ø–∫—É –≤ .nav-cta
    if(!btn){
      const cta = nav.querySelector(".nav-cta");
      if(cta) btn = cta.querySelector("a:last-of-type");
    }

    return btn || null;
  }

  function setBtn(btn, mode){
    // —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å—Ç–∏–ª—å –∏ —Ç–µ–∫—Å—Ç
    btn.classList.add("ai-cta", "btn", "primary");
    btn.setAttribute("href", ADD_PATH);
    btn.textContent = (mode === "cabinet") ? "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" : "–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ";

    // –∂—ë—Å—Ç–∫–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫, —á—Ç–æ–±—ã –ù–ï –æ—Ç–∫—Ä—ã–≤–∞–ª–∞—Å—å —Å—Ç–∞—Ä–∞—è /apply
    btn.addEventListener("click", function(e){
      e.preventDefault();
      location.href = ADD_PATH;
    }, true);
  }

  async function waitSupabase(){
    for(let i=0;i<120;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r=>setTimeout(r,100));
    }
    return null;
  }

  async function init(){
    // –∂–¥—ë–º –ø–æ–∫–∞ —à–∞–ø–∫–∞ —Ä–µ–∞–ª—å–Ω–æ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    let btn = null;
    for(let i=0;i<120;i++){
      btn = findHeaderBtn();
      if(btn) break;
      await new Promise(r=>setTimeout(r,100));
    }
    if(!btn) return;

    // –¥–µ—Ñ–æ–ª—Ç
    setBtn(btn, "portfolio");

    // –µ—Å–ª–∏ –µ—Å—Ç—å supabase ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞
    const sb = await waitSupabase();
    if(!sb) return;

    const { data: authData } = await sb.auth.getUser();
    const user = authData?.user;
    if(!user) return;

    const { data, error } = await sb.from("experts").select("id").eq("user_id", user.id).limit(1);
    if(!error && data && data.length > 0) setBtn(btn, "cabinet");
    else setBtn(btn, "portfolio");
  }

  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
</script> <style>
/* –¢–µ–≥–∏-—á–∏–ø—Å—ã –ø–æ–¥ –ø–æ–ª–µ–º "–†–æ–ª—å" (—Ç–æ–ª—å–∫–æ –Ω–∞ /add) */
#roleChips{ margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; }
#roleChips .tag{ cursor:pointer; user-select:none; }
#roleChips .tag:after{ content:" √ó"; opacity:.55; margin-left:4px; }
</style> <script>
(function(){
  function normTags(str){
    return String(str||"")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean)
      .slice(0, 20);
  }
  function uniq(arr){
    const out=[], seen=new Set();
    for(const x of arr){
      const k = x.toLowerCase();
      if(!seen.has(k)){ seen.add(k); out.push(x); }
    }
    return out;
  }

  // 1) /add: –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤ —á–∏–ø—Å—ã –ø–æ–¥ –∏–Ω–ø—É—Ç–æ–º
  function enhanceRoleInput(){
    if(!location.pathname.startsWith("/add")) return;

    const input = document.getElementById("f_role");
    if(!input || input.dataset.tagsEnhanced) return;
    input.dataset.tagsEnhanced = "1";

    const field = input.closest(".field") || input.parentElement;
    if(!field) return;

    const chips = document.createElement("div");
    chips.id = "roleChips";
    chips.className = "tagrow";
    field.appendChild(chips);

    function renderChips(){
      const tags = uniq(normTags(input.value));
      chips.innerHTML = tags.map(t => `<span class="tag" data-t="${t.replace(/"/g,"&quot;")}">${t}</span>`).join("");
    }

    function normalizeAndRender(){
      const tags = uniq(normTags(input.value));
      input.value = tags.join(", ");
      renderChips();
    }

    chips.addEventListener("click", (e)=>{
      const tagEl = e.target.closest(".tag");
      if(!tagEl) return;
      const t = (tagEl.getAttribute("data-t") || tagEl.textContent || "").trim();
      const tags = uniq(normTags(input.value)).filter(x => x.toLowerCase() !== t.toLowerCase());
      input.value = tags.join(", ");
      renderChips();
    });

    input.addEventListener("input", renderChips);
    input.addEventListener("blur", normalizeAndRender);

    normalizeAndRender();
  }

  // 2) –í –∫–∞—Ç–∞–ª–æ–≥–µ/–ø—Ä–æ—Ñ–∏–ª–µ: –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –µ—Å—Ç—å .tag —Å –∑–∞–ø—è—Ç—ã–º–∏ ‚Äî —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–ª–∞—à–∫–∏
  function splitCommaTagsEverywhere(root=document){
    const tags = root.querySelectorAll ? root.querySelectorAll(".tagrow .tag") : [];
    tags.forEach(tag=>{
      if(tag.closest && tag.closest("#roleChips")) return; // –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —á–∏–ø—Å—ã –≤ –∫–∞–±–∏–Ω–µ—Ç–µ

      const txt = (tag.textContent || "").trim();
      if(!txt.includes(",")) return;

      const parts = uniq(normTags(txt));
      if(parts.length <= 1) return;

      const frag = document.createDocumentFragment();
      parts.forEach(p=>{
        const el = tag.cloneNode(false);
        el.className = tag.className;
        el.textContent = p;
        frag.appendChild(el);
      });
      tag.replaceWith(frag);
    });
  }

  function runAll(){
    enhanceRoleInput();
    splitCommaTagsEverywhere(document);
  }

  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", runAll);
  else runAll();

})();
</script> <style>
/* ===== FAST TAGS (–±–µ–∑ MutationObserver) ===== */
#roleChips{ margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; }
#roleChips .tag{ cursor:pointer; user-select:none; }
#roleChips .tag:after{ content:" √ó"; opacity:.55; margin-left:4px; }

.ai-linkrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
.ai-linkrow .btn{white-space:nowrap}

/* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å–∏–Ω–µ–π */
.btn.primary, .btn.primary *{ color:#fff !important; -webkit-text-fill-color:#fff !important; }
</style> <script>
(function(){
  /* ---------- utils ---------- */
  function normTags(str){
    return String(str||"")
      .split(",")
      .map(s=>s.trim())
      .filter(Boolean)
      .slice(0, 30);
  }
  function uniq(arr){
    const out=[], seen=new Set();
    for(const x of arr){
      const k=x.toLowerCase();
      if(!seen.has(k)){ seen.add(k); out.push(x); }
    }
    return out;
  }
  function splitCommaTagsOnce(){
    document.querySelectorAll(".tagrow .tag").forEach(tag=>{
      if(tag.closest && tag.closest("#roleChips")) return;
      const txt=(tag.textContent||"").trim();
      if(!txt.includes(",")) return;
      const parts=uniq(normTags(txt));
      if(parts.length<=1) return;

      const frag=document.createDocumentFragment();
      parts.forEach(p=>{
        const el=tag.cloneNode(false);
        el.className=tag.className;
        el.textContent=p;
        frag.appendChild(el);
      });
      tag.replaceWith(frag);
    });
  }

  function extractTgNick(v){
    v=String(v||"").trim();
    if(!v) return "";
    const m=v.match(/(?:t\.me|telegram\.me)\/([A-Za-z0-9_]{3,})/i);
    if(m && m[1]) return m[1];
    return v.replace(/^@+/,"").trim();
  }
  function tgLink(v){
    const nick=extractTgNick(v);
    return nick ? ("https://t.me/" + nick) : "";
  }
  function normalizeWebsite(v){
    v=String(v||"").trim();
    if(!v) return "";
    if(/^https?:\/\//i.test(v)) return v;
    return "https://" + v;
  }
  function normalizeInstagram(v){
    v=String(v||"").trim();
    if(!v) return "";
    if(/^https?:\/\//i.test(v)) return v;
    v=v.replace(/^@+/,"").trim();
    return v ? ("https://www.instagram.com/" + v + "/") : "";
  }

  async function waitSb(){
    for(let i=0;i<80;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r=>setTimeout(r,120));
    }
    return null;
  }

  /* ---------- 1) /add: —á–∏–ø—Å—ã –ø–æ–¥ –ø–æ–ª–µ–º —Ç–µ–≥–æ–≤ ---------- */
  function enhanceRoleInput(){
    if(!location.pathname.startsWith("/add")) return;
    const input=document.getElementById("f_role");
    if(!input || input.dataset.tagsEnhanced) return;
    input.dataset.tagsEnhanced="1";

    const field=input.closest(".field") || input.parentElement;
    if(!field) return;

    const chips=document.createElement("div");
    chips.id="roleChips";
    chips.className="tagrow";
    field.appendChild(chips);

    function render(){
      const tags=uniq(normTags(input.value));
      chips.innerHTML=tags.map(t=>`<span class="tag" data-t="${t.replace(/"/g,"&quot;")}">${t}</span>`).join("");
    }
    function normalize(){
      const tags=uniq(normTags(input.value));
      input.value=tags.join(", ");
      render();
    }

    chips.addEventListener("click",(e)=>{
      const el=e.target.closest(".tag");
      if(!el) return;
      const t=(el.getAttribute("data-t")||el.textContent||"").trim();
      const tags=uniq(normTags(input.value)).filter(x=>x.toLowerCase()!==t.toLowerCase());
      input.value=tags.join(", ");
      render();
    });

    input.addEventListener("input", render);
    input.addEventListener("blur", normalize);

    normalize();
  }

  /* ---------- 2) –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ä—Ç–æ—á–∫–∏: –¥–æ—Ä–∏—Å–æ–≤–∞—Ç—å Instagram/–°–∞–π—Ç/–û–ø–∏—Å–∞–Ω–∏–µ ---------- */
  async function enhanceExpertPage(){
    const qs=new URLSearchParams(location.search);
    const id = qs.get("id") || qs.get("expert") || qs.get("expert_id");
    if(!id) return; // –Ω–µ—Ç id -> –Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ä—Ç–æ—á–∫–∏

    // –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–ø–∏—Å–∫–∞ /experts
    if(location.pathname === "/experts") return;

    const sb=await waitSb();
    if(!sb) return;

    const { data: expert, error } = await sb
      .from("experts")
      .select("id, description, instagram, website, telegram")
      .eq("id", id)
      .single();

    if(error || !expert) return;

    // –ö—É–¥–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å: –∏—â–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"
    const msgBtn = Array.from(document.querySelectorAll("a.btn, button.btn"))
      .find(el => /–Ω–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ/i.test((el.textContent||"").trim()));

    let host = null;
    if(msgBtn && msgBtn.parentElement) host = msgBtn.parentElement;

    // –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –≤—Å—Ç–∞–≤–∏–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–π h-card
    if(!host){
      host = document.querySelector(".h-card") || document.querySelector(".container") || document.body;
    }

    // –ö–æ–Ω—Ç–∞–∫—Ç—ã (Instagram/–°–∞–π—Ç)
    const ig = normalizeInstagram(expert.instagram);
    const site = normalizeWebsite(expert.website);

    if((ig || site) && !document.getElementById("aiLinksRow")){
      const row = document.createElement("div");
      row.className="ai-linkrow";
      row.id="aiLinksRow";

      if(ig){
        const a=document.createElement("a");
        a.className="btn";
        a.href=ig; a.target="_blank"; a.rel="noopener";
        a.textContent="Instagram";
        row.appendChild(a);
      }
      if(site){
        const a=document.createElement("a");
        a.className="btn";
        a.href=site; a.target="_blank"; a.rel="noopener";
        a.textContent="–°–∞–π—Ç";
        row.appendChild(a);
      }

      // –≤—Å—Ç–∞–≤–ª—è–µ–º —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–∞–º–∏
      if(msgBtn && msgBtn.parentElement){
        msgBtn.parentElement.appendChild(row);
      }else{
        host.appendChild(row);
      }
    }

    // –ï—Å–ª–∏ —Ç–µ–ª–µ–≥–∞ –∫–Ω–æ–ø–∫–∞ –µ—Å—Ç—å, –Ω–æ —Å—Å—ã–ª–∫–∞ –ø—É—Å—Ç–∞—è ‚Äî –º–æ–∂–µ–º –ø–æ–ø—Ä–∞–≤–∏—Ç—å
    const tg = tgLink(expert.telegram);
    if(tg && msgBtn && msgBtn.tagName.toLowerCase()==="a"){
      msgBtn.href = tg;
      msgBtn.target = "_blank";
      msgBtn.rel = "noopener";
    }

    // –û–ø–∏—Å–∞–Ω–∏–µ (–µ—Å–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –µ–≥–æ —Ä–µ–∞–ª—å–Ω–æ –Ω–µ—Ç)
    const desc = String(expert.description||"").trim();
    if(desc){
      const alreadyHas = document.body && (document.body.innerText || "").includes(desc.slice(0, Math.min(25, desc.length)));
      if(!alreadyHas && !document.getElementById("aiDescBlock")){
        const block = document.createElement("div");
        block.id="aiDescBlock";
        block.className="h-card";
        block.style.marginTop="14px";
        block.innerHTML = `
          <h2 class="section-title" style="margin:0 0 8px">–û–ø–∏—Å–∞–Ω–∏–µ</h2> <div class="section-sub" style="margin:0;white-space:pre-wrap">${desc.replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]))}</div>
        `;
        (document.querySelector(".container") || host).appendChild(block);
      }
    }
  }

  /* ---------- run ---------- */
  function run(){
    enhanceRoleInput();

    // —Ä–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–≥–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ (–±—ã—Å—Ç—Ä–æ, –±–µ–∑ observer)
    splitCommaTagsOnce();
    setTimeout(splitCommaTagsOnce, 400);
    setTimeout(splitCommaTagsOnce, 1400);

    enhanceExpertPage();
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", run);
  else run();
})();
</script> <style>
/* =========================
   AI-–ë–∏—Ä–∂–∞ ‚Ä¢ Lightbox + CARD thumbs
   ========================= */

/* 1) –ù–∞ CARD (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ä—Ç–æ—á–∫–∏): –ø—Ä–µ–≤—å—é –ë–ï–ó –ü–û–õ–ï–ô */
html[data-ai-page="card"] #allrecords .ab-gallery-item,
html[data-ai-page="card"] .t-records .ab-gallery-item{
  position: relative;
  overflow: hidden;
  border-radius: 18px;
  background: transparent !important;
}

/* –î–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø—Ä–µ–≤—å—é –≤ –≥–∞–ª–µ—Ä–µ–µ –Ω–∞ CARD (–º–æ–∂–µ—à—å –º–µ–Ω—è—Ç—å) */
html[data-ai-page="card"] #allrecords .ab-gallery-item{ aspect-ratio: 16 / 10; }
html[data-ai-page="card"] .t-records .ab-gallery-item{ aspect-ratio: 16 / 10; }

html[data-ai-page="card"] #allrecords .ab-gallery-item img,
html[data-ai-page="card"] #allrecords .ab-gallery-item video,
html[data-ai-page="card"] .t-records .ab-gallery-item img,
html[data-ai-page="card"] .t-records .ab-gallery-item video{
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;      /* –í–û–¢ –≠–¢–û —É–±–∏—Ä–∞–µ—Ç –ø–æ–ª—è */
  background: transparent !important; /* –Ω–µ —Ä–∏—Å—É–µ–º —á–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
  display:block;
}

/* –ß—Ç–æ–±—ã –≤–∏–¥–µ–æ –≤ –ø—Ä–µ–≤—å—é –Ω–µ –º–µ—à–∞–ª–æ –∫–ª–∏–∫—É (–º—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ª–∞–π—Ç–±–æ–∫—Å) */
html[data-ai-page="card"] .ab-gallery-item video{
  pointer-events: none;
}

/* 2) Lightbox */
.ab-lb{
  position: fixed; inset: 0;
  z-index: 999999;
  background: rgba(10,20,40,.62);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
}
.ab-lb.open{ display:flex; }

.ab-lb__inner{
  width: min(1080px, 96vw);
  max-height: 92vh;
  border-radius: 22px;
  overflow: hidden;
  background: rgba(255,255,255,.9);
  box-shadow: 0 20px 60px rgba(0,0,0,.25);
  position: relative;
}

.ab-lb__top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 10px 12px;
  background: rgba(255,255,255,.85);
  border-bottom: 1px solid rgba(0,0,0,.06);
}

.ab-lb__title{
  font-size: 14px;
  color: rgba(20,35,63,.8);
  font-weight: 700;
  overflow:hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.ab-lb__close{
  border: none;
  border-radius: 14px;
  padding: 10px 12px;
  cursor: pointer;
  background: rgba(240,245,255,.9);
  box-shadow: inset 6px 6px 14px rgba(163,177,198,.25), inset -6px -6px 14px rgba(255,255,255,.9);
  font-weight: 900;
}

.ab-lb__stage{
  background: #0b0c10; /* —Ñ–æ–Ω –¥–ª—è full-view */
  display:flex;
  align-items:center;
  justify-content:center;
  width: 100%;
  height: calc(92vh - 52px);
  max-height: calc(92vh - 52px);
  position: relative;
}

.ab-lb__stage img,
.ab-lb__stage video{
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain; /* –í full-view –ù–ï —Ä–µ–∂–µ–º */
  background: #000;
}

.ab-lb__nav{
  position:absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 44px;
  height: 44px;
  border: none;
  border-radius: 16px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(255,255,255,.88);
  box-shadow: 0 10px 30px rgba(0,0,0,.18);
  font-size: 20px;
  font-weight: 900;
  user-select:none;
}
.ab-lb__nav.prev{ left: 12px; }
.ab-lb__nav.next{ right: 12px; }

@media (max-width: 640px){
  .ab-lb__nav{ width: 40px; height: 40px; border-radius: 14px; }
  .ab-lb__stage{ height: calc(92vh - 52px); }
}
</style> <script>
(function(){
  /* -------------------------
     0) –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å—Ç—Ä–∞–Ω–∏—Ü—ã
     ------------------------- */
  function detectPage(){
    const path = location.pathname.replace(/\/+$/,'');
    const qs = new URLSearchParams(location.search);

    // /add = –∫–∞–±–∏–Ω–µ—Ç/—Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (—Ç–∞–º –Ω–∞–º –ù–ï –Ω–∞–¥–æ cover)
    if(path === "/add") return "add";

    // CARD: —É —Ç–µ–±—è —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å /card –∏–ª–∏ /profile –∏ —Ç.–ø.
    // –û–ø—Ä–µ–¥–µ–ª–∏–º –ø–æ –Ω–∞–ª–∏—á–∏—é id –∏ —Å–ª–æ–≤–∞ "–ö–∞—Ä—Ç–æ—á–∫–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    const hasId = qs.get("id") || qs.get("expert") || qs.get("expert_id");
    const hasCardTitle = Array.from(document.querySelectorAll("h1,h2,h3"))
      .some(h => /–∫–∞—Ä—Ç–æ—á–∫–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è/i.test(h.textContent||""));
    if(hasId && hasCardTitle) return "card";

    return "other";
  }

  function setPageDataset(){
    document.documentElement.dataset.aiPage = detectPage();
  }

  /* -------------------------
     1) –ù–∞—Ö–æ–¥–∏–º –≥–∞–ª–µ—Ä–µ—é –Ω–∞ CARD
     ------------------------- */
  function getGalleryRoot(){
    // –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π id ‚Äî –ø–æ–¥—Ö–≤–∞—Ç–∏–º
    const byId = document.getElementById("galleryGrid") || document.getElementById("expertGallery") || document.getElementById("mediaGallery");
    if(byId) return byId;

    // –∏—â–µ–º —Å–µ–∫—Ü–∏—é, –≥–¥–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–ì–∞–ª–µ—Ä–µ—è"
    const headings = Array.from(document.querySelectorAll("h2,h3"));
    const h = headings.find(x => (x.textContent||"").trim().toLowerCase() === "–≥–∞–ª–µ—Ä–µ—è");
    if(h){
      // –æ–±—ã—á–Ω–æ –≥–∞–ª–µ—Ä–µ—è —Ä—è–¥–æ–º/–Ω–∏–∂–µ
      return h.closest(".h-card") || h.parentElement;
    }

    return null;
  }

  /* -------------------------
     2) –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ items
     ------------------------- */
  function buildItems(root){
    // –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞
    const nodes = Array.from(root.querySelectorAll("img, video"));
    const items = [];

    nodes.forEach((el) => {
      const wrap = el.closest(".ab-gallery-item") || el.parentElement;

      // –ø–æ–º–µ—á–∞–µ–º –æ–±—ë—Ä—Ç–∫—É –∫–∞–∫ —ç–ª–µ–º–µ–Ω—Ç –≥–∞–ª–µ—Ä–µ–∏ (–¥–ª—è CSS cover –Ω–∞ CARD)
      if(wrap && !wrap.classList.contains("ab-gallery-item")){
        wrap.classList.add("ab-gallery-item");
        wrap.style.cursor = "pointer";
      }

      if(el.tagName.toLowerCase() === "img"){
        const src = el.currentSrc || el.src;
        if(src) items.push({ type:"img", src });
      } else {
        const src = el.currentSrc || el.src || (el.querySelector("source") ? el.querySelector("source").src : "");
        if(src) items.push({ type:"video", src });
      }
    });

    return items;
  }

  /* -------------------------
     3) Lightbox UI
     ------------------------- */
  function ensureLightbox(){
    let lb = document.getElementById("abLightbox");
    if(lb) return lb;

    lb = document.createElement("div");
    lb.id = "abLightbox";
    lb.className = "ab-lb";
    lb.innerHTML = `
      <div class="ab-lb__inner" role="dialog" aria-modal="true"> <div class="ab-lb__top"> <div class="ab-lb__title" id="abLbTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä</div> <button class="ab-lb__close" type="button" id="abLbClose">‚úï</button> </div> <div class="ab-lb__stage" id="abLbStage"> <button class="ab-lb__nav prev" type="button" id="abLbPrev" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ">‚Äπ</button> <button class="ab-lb__nav next" type="button" id="abLbNext" aria-label="–°–ª–µ–¥—É—é—â–µ–µ">‚Ä∫</button> </div> </div>
    `;
    document.body.appendChild(lb);
    return lb;
  }

  function openLb(state, index){
    const lb = ensureLightbox();
    const stage = lb.querySelector("#abLbStage");
    const title = lb.querySelector("#abLbTitle");
    const items = state.items;

    state.index = (index + items.length) % items.length;

    // —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–∫—Ä–æ–º–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
    Array.from(stage.children).forEach(ch=>{
      if(ch.id === "abLbPrev" || ch.id === "abLbNext") return;
      ch.remove();
    });

    const cur = items[state.index];
    title.textContent = (state.index + 1) + " / " + items.length;

    if(cur.type === "img"){
      const img = document.createElement("img");
      img.src = cur.src;
      img.alt = "";
      stage.appendChild(img);
    } else {
      const v = document.createElement("video");
      v.src = cur.src;
      v.controls = true;
      v.autoplay = true;
      v.playsInline = true;
      v.preload = "metadata";
      stage.appendChild(v);
    }

    lb.classList.add("open");
    document.body.style.overflow = "hidden";
  }

  function closeLb(){
    const lb = document.getElementById("abLightbox");
    if(!lb) return;
    lb.classList.remove("open");
    document.body.style.overflow = "";
  }

  /* -------------------------
     4) Swipe –Ω–∞ –º–æ–±–∏–ª–µ
     ------------------------- */
  function enableSwipe(stage, onPrev, onNext){
    let x0 = null, y0 = null;
    stage.addEventListener("touchstart", (e)=>{
      const t = e.touches[0];
      x0 = t.clientX; y0 = t.clientY;
    }, {passive:true});

    stage.addEventListener("touchend", (e)=>{
      if(x0===null) return;
      const t = e.changedTouches[0];
      const dx = t.clientX - x0;
      const dy = t.clientY - y0;
      x0 = null; y0 = null;

      if(Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy)){
        if(dx > 0) onPrev();
        else onNext();
      }
    }, {passive:true});
  }

  /* -------------------------
     5) Init
     ------------------------- */
  function init(){
    setPageDataset();
    if(document.documentElement.dataset.aiPage !== "card") return;

    const root = getGalleryRoot();
    if(!root) return;

    const items = buildItems(root);
    if(items.length === 0) return;

    const state = { items, index: 0 };

    // –∫–ª–∏–∫–∏ –ø–æ –ª—é–±–æ–º—É img/video –≤ –≥–∞–ª–µ—Ä–µ–µ ‚Üí –æ—Ç–∫—Ä—ã—Ç—å
    root.addEventListener("click", (e)=>{
      const el = e.target.closest("img, video");
      if(!el) return;

      const src = el.currentSrc || el.src || (el.querySelector && el.querySelector("source") ? el.querySelector("source").src : "");
      const idx = state.items.findIndex(x => x.src === src);
      openLb(state, idx >= 0 ? idx : 0);
    });

    // –Ω–∞–≤–∏–≥–∞—Ü–∏—è/–∑–∞–∫—Ä—ã—Ç–∏–µ
    const lb = ensureLightbox();
    const prev = lb.querySelector("#abLbPrev");
    const next = lb.querySelector("#abLbNext");
    const close = lb.querySelector("#abLbClose");
    const stage = lb.querySelector("#abLbStage");

    function goPrev(){ openLb(state, state.index - 1); }
    function goNext(){ openLb(state, state.index + 1); }

    prev.onclick = goPrev;
    next.onclick = goNext;
    close.onclick = closeLb;

    // –∫–ª–∏–∫ –ø–æ —Ñ–æ–Ω—É –∑–∞–∫—Ä—ã–≤–∞–µ—Ç
    lb.addEventListener("click", (e)=>{
      if(e.target === lb) closeLb();
    });

    // –∫–ª–∞–≤–∏—à–∏
    document.addEventListener("keydown", (e)=>{
      const opened = lb.classList.contains("open");
      if(!opened) return;
      if(e.key === "Escape") closeLb();
      if(e.key === "ArrowLeft") goPrev();
      if(e.key === "ArrowRight") goNext();
    });

    enableSwipe(stage, goPrev, goNext);
  }

  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();

  // –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: Tilda –∏–Ω–æ–≥–¥–∞ –¥–æ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –±–ª–æ–∫–∏ –ø–æ–∑–∂–µ
  setTimeout(()=>{ try{ init(); }catch(e){} }, 600);
  setTimeout(()=>{ try{ init(); }catch(e){} }, 1600);
})();
</script> <style>
  /* —Å–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É "–ß—Ç–æ –≤–Ω—É—Ç—Ä–∏" */
  .ai-hide-what-inside{display:none!important;}

  /* –µ—Å–ª–∏ –≤ hero-grid –æ—Å—Ç–∞–ª–∞—Å—å –æ–¥–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ ‚Äî –¥–µ–ª–∞–µ–º 1 –∫–æ–ª–æ–Ω–∫—É */
  .hero-grid.ai-hero-onecol{grid-template-columns:1fr!important;}
</style> <script>
(function () {
  function norm(s){ return (s||'').replace(/\s+/g,' ').trim().toLowerCase(); }

  function hideFrom(el){
    const card =
      el.closest('.h-card') ||
      el.closest('.t-rec') ||
      el.closest('#allrecords > div') ||
      el.parentElement;

    if(card){
      card.classList.add('ai-hide-what-inside');

      // –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–∞–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –≤ hero-grid ‚Äî —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –ª–µ–≤—É—é
      const grid = card.closest('.hero-grid');
      if(grid){
        const visible = Array.from(grid.querySelectorAll('.h-card'))
          .filter(c => !c.classList.contains('ai-hide-what-inside'));
        if(visible.length <= 1) grid.classList.add('ai-hero-onecol');
      }
    }
  }

  function run(){
    // 1) –∏—â–µ–º –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É "–ß—Ç–æ –≤–Ω—É—Ç—Ä–∏"
    document.querySelectorAll('h1,h2,h3').forEach(function(h){
      if(norm(h.textContent) === '—á—Ç–æ –≤–Ω—É—Ç—Ä–∏') hideFrom(h);
    });

    // 2) fallback: –∏—â–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –±–µ–π–¥–∂–µ–º "MVP" –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º "–ß—Ç–æ –≤–Ω—É—Ç—Ä–∏"
    document.querySelectorAll('.badge').forEach(function(b){
      if(norm(b.textContent) === 'mvp'){
        const card = b.closest('.h-card');
        if(!card) return;
        const h = card.querySelector('h1,h2,h3');
        if(h && norm(h.textContent) === '—á—Ç–æ –≤–Ω—É—Ç—Ä–∏'){
          card.classList.add('ai-hide-what-inside');
          const grid = card.closest('.hero-grid');
          if(grid) grid.classList.add('ai-hero-onecol');
        }
      }
    });
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }
})();
</script> <script>
(function () {
  if (window.__AI_ALBUMS_FORCE_V1__) return;
  window.__AI_ALBUMS_FORCE_V1__ = true;

  function onReady(fn){
    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
    else fn();
  }

  function loadScript(src){
    return new Promise((resolve, reject)=>{
      const s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = resolve; s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  async function getSB(){
    // 1) –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å ‚Äî –æ–∫
    if (window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;

    // 2) –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥
    if (!window.AI_BIRZHA || !window.AI_BIRZHA.SUPABASE_URL || !window.AI_BIRZHA.SUPABASE_ANON_KEY) {
      console.warn('[ALBUMS] –ù–µ—Ç window.AI_BIRZHA.SUPABASE_URL / ANON_KEY');
      return null;
    }

    // 3) –µ—Å–ª–∏ supabase-js –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω ‚Äî –ø–æ–¥–∫–ª—é—á–∞–µ–º
    if (!window.supabase) {
      await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
    }

    // 4) —Å–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç
    window.AI_BIRZHA.sb = window.supabase.createClient(
      window.AI_BIRZHA.SUPABASE_URL,
      window.AI_BIRZHA.SUPABASE_ANON_KEY
    );
    return window.AI_BIRZHA.sb;
  }

  function mountAlbumsUI(){
    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –Ω–∞ /add
    if (!location.pathname.includes('/add')) return;
    if (document.getElementById('aiAlbumsAdd')) return;

    const host =
      document.querySelector('.h-card') ||
      document.querySelector('#allrecords') ||
      document.querySelector('.t-records') ||
      document.body;

    const box = document.createElement('div');
    box.className = 'h-card';
    box.id = 'aiAlbumsAdd';
    box.style.marginTop = '16px';
    box.innerHTML = `
      <div class="h-eyebrow">–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</div>
      <h2 class="section-title" style="margin:8px 0 0">–ê–ª—å–±–æ–º—ã</h2>
      <p class="section-sub" style="margin:8px 0 0">–°–æ–∑–¥–∞–≤–∞–π –∞–ª—å–±–æ–º—ã –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–π –º–µ–¥–∏–∞ –ø–æ –Ω–∏–º.</p>
      
      <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞ -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:end;margin-top:16px;padding:16px;background:#f5f5f5;border-radius:8px">
        <div style="flex:1 1 240px">
          <label style="font-weight:600;margin-bottom:6px;display:block">–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–ª—å–±–æ–º–∞</label>
          <input id="aiAlbumTitle" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∏–ª—Å—ã" />
        </div>
        <button class="btn primary" type="button" id="aiAlbumCreate">–°–æ–∑–¥–∞—Ç—å –∞–ª—å–±–æ–º</button>
      </div>
      
      <!-- –°—Ç–∞—Ç—É—Å -->
      <div class="small" id="aiAlbumsStatus" style="margin-top:10px;color:#0ea5e9"></div>
      
      <!-- –°–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤ -->
      <div id="aiAlbumsList" style="margin-top:20px"></div>
    `;

    // –≤—Å—Ç–∞–≤–∏–º –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ .h-card (–∞ –Ω–µ "–≤–Ω—É—Ç—Ä—å"), —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –±—ã–ª–æ –≤–∏–¥–Ω–æ
    if (host.classList && host.classList.contains('h-card')) host.insertAdjacentElement('afterend', box);
    else host.appendChild(box);
  }

  onReady(async function(){
    // 1) –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—Å—Ç–∞–≤–ª—è–µ–º UI (–∫–Ω–æ–ø–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è —Å—Ä–∞–∑—É)
    mountAlbumsUI();

    // 2) –ø–æ–¥–∫–ª—é—á–∞–µ–º Supabase –∏ –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–∞–±–æ—á–µ–π
    const sb = await getSB();
    const status = document.getElementById('aiAlbumsStatus');
    const btn = document.getElementById('aiAlbumCreate');
    const title = document.getElementById('aiAlbumTitle');
    const albumsList = document.getElementById('aiAlbumsList');

    if (!status || !btn || !title || !albumsList) return;

    if (!sb) {
      status.textContent = '–û—à–∏–±–∫–∞: Supabase –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤ HEAD –µ—Å—Ç—å window.AI_BIRZHA (URL + KEY).';
      return;
    }

    const { data: authData } = await sb.auth.getUser();
    const user = authData?.user;
    if (!user) {
      status.textContent = '–í–æ–π–¥–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –∞–ª—å–±–æ–º—ã.';
      btn.disabled = true;
      return;
    }

    // –Ω–∞–π–¥—ë–º expert_id
    const ex = await sb.from('experts').select('id').eq('user_id', user.id).limit(1);
    const expertId = ex?.data?.[0]?.id;
    if (!expertId) {
      status.textContent = '–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –∫–∞—Ä—Ç–æ—á–∫—É. –ü–æ—Ç–æ–º —Å–æ–∑–¥–∞–≤–∞–π –∞–ª—å–±–æ–º—ã.';
      btn.disabled = true;
      return;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∞–ª—å–±–æ–º–æ–≤
    async function loadAlbums() {
      const { data: albums, error } = await sb
        .from('expert_albums')
        .select('id, title, created_at')
        .eq('expert_id', expertId)
        .order('created_at', { ascending: false });

      if (error) {
        status.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª—å–±–æ–º–æ–≤: ' + error.message;
        return;
      }

      if (!albums || albums.length === 0) {
        albumsList.innerHTML = '<p class="small" style="color:#888">–ê–ª—å–±–æ–º–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤—ã–π!</p>';
        return;
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–¥–∏–∞ –≤ –∫–∞–∂–¥–æ–º –∞–ª—å–±–æ–º–µ
      const albumsWithCounts = await Promise.all(albums.map(async (album) => {
        const { count } = await sb
          .from('expert_media')
          .select('id', { count: 'exact', head: true })
          .eq('album_id', album.id);
        return { ...album, mediaCount: count || 0 };
      }));

      // –†–µ–Ω–¥–µ—Ä–∏–º –∞–ª—å–±–æ–º—ã
      albumsList.innerHTML = albumsWithCounts.map(album => `
        <div class="album-card" data-album-id="${album.id}" style="
          padding:16px;
          margin-bottom:12px;
          border:1px solid #e5e5e5;
          border-radius:8px;
          background:#fff;
          display:flex;
          justify-content:space-between;
          align-items:center;
          flex-wrap:wrap;
          gap:12px
        ">
          <div style="flex:1">
            <h3 style="margin:0 0 4px;font-size:18px;font-weight:600">${escapeHtml(album.title)}</h3>
            <p class="small" style="margin:0;color:#666">${album.mediaCount} –º–µ–¥–∏–∞</p>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn album-manage" data-album-id="${album.id}" type="button">–£–ø—Ä–∞–≤–ª—è—Ç—å –º–µ–¥–∏–∞</button>
            <button class="btn album-delete" data-album-id="${album.id}" type="button" style="background:#ef4444;color:#fff">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `).join('');

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∞–ª—å–±–æ–º–æ–≤
      document.querySelectorAll('.album-manage').forEach(btn => {
        btn.addEventListener('click', () => openAlbumManager(btn.dataset.albumId));
      });

      document.querySelectorAll('.album-delete').forEach(btn => {
        btn.addEventListener('click', () => deleteAlbum(btn.dataset.albumId));
      });
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞
    btn.addEventListener('click', async function(){
      const t = (title.value || '').trim();
      if(!t) return alert('–ù–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞.');

      status.textContent = '–°–æ–∑–¥–∞—é –∞–ª—å–±–æ–º...';
      const r = await sb.from('expert_albums').insert({
        expert_id: expertId,
        user_id: user.id,
        title: t
      }).select('id,title');

      if (r.error){
        status.textContent = '–û—à–∏–±–∫–∞: ' + r.error.message;
        return;
      }

      status.textContent = '‚úÖ –ê–ª—å–±–æ–º —Å–æ–∑–¥–∞–Ω: ' + (r.data?.[0]?.title || t);
      title.value = '';
      await loadAlbums();
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ –∞–ª—å–±–æ–º–∞
    async function deleteAlbum(albumId) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∞–ª—å–±–æ–º? –ú–µ–¥–∏–∞ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ.')) return;
      
      status.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';
      
      // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–≤—è–∑—ã–≤–∞–µ–º –º–µ–¥–∏–∞ –æ—Ç –∞–ª—å–±–æ–º–∞
      await sb.from('expert_media').update({ album_id: null }).eq('album_id', albumId);
      
      // –ó–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º –∞–ª—å–±–æ–º
      const { error } = await sb.from('expert_albums').delete().eq('id', albumId);
      
      if (error) {
        status.textContent = '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message;
        return;
      }
      
      status.textContent = '‚úÖ –ê–ª—å–±–æ–º —É–¥–∞–ª—ë–Ω';
      await loadAlbums();
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞ –≤ –∞–ª—å–±–æ–º–µ
    function openAlbumManager(albumId) {
      // –°–æ–∑–¥–∞—ë–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏–∞
      const modal = document.createElement('div');
      modal.id = 'albumMediaModal';
      modal.style.cssText = `
        position:fixed;
        top:0;left:0;right:0;bottom:0;
        background:rgba(0,0,0,0.5);
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:9999;
        padding:20px;
      `;
      
      modal.innerHTML = `
        <div style="
          background:#fff;
          border-radius:12px;
          padding:24px;
          max-width:800px;
          width:100%;
          max-height:80vh;
          overflow-y:auto;
        ">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h2 style="margin:0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞ –≤ –∞–ª—å–±–æ–º–µ</h2>
            <button class="btn" id="closeAlbumModal">‚úï</button>
          </div>
          <div id="albumMediaContent">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
      document.getElementById('closeAlbumModal').addEventListener('click', () => {
        modal.remove();
      });
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–¥–∏–∞
      loadAlbumMedia(albumId);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞ –¥–ª—è –∞–ª—å–±–æ–º–∞
    async function loadAlbumMedia(albumId) {
      const content = document.getElementById('albumMediaContent');
      
      // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞
      const { data: album } = await sb.from('expert_albums').select('title').eq('id', albumId).single();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –º–µ–¥–∏–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const { data: allMedia } = await sb
        .from('expert_media')
        .select('id, media_type, storage_path, album_id, created_at')
        .eq('expert_id', expertId)
        .order('created_at', { ascending: false });
      
      if (!allMedia || allMedia.length === 0) {
        content.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–µ–¥–∏–∞.</p>';
        return;
      }
      
      // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ URL –¥–ª—è –≤—Å–µ—Ö –º–µ–¥–∏–∞
      const paths = allMedia.map(m => m.storage_path);
      const { data: urls } = await sb.storage.from('experts-media').createSignedUrls(paths, 60*60);
      const urlByPath = new Map();
      (urls || []).forEach(x => { if(x?.path && x?.signedUrl) urlByPath.set(x.path, x.signedUrl); });
      
      // –î–æ–±–∞–≤–ª—è–µ–º URL –∫ –∫–∞–∂–¥–æ–º—É –º–µ–¥–∏–∞
      const mediaWithUrls = allMedia.map(m => ({
        ...m,
        url: urlByPath.get(m.storage_path) || ''
      }));
      
      // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –º–µ–¥–∏–∞ –≤ –∞–ª—å–±–æ–º–µ –∏ –≤–Ω–µ –µ–≥–æ
      const inAlbum = mediaWithUrls.filter(m => m.album_id === albumId);
      const notInAlbum = mediaWithUrls.filter(m => !m.album_id || m.album_id !== albumId);
      
      content.innerHTML = `
        <h3 style="margin:0 0 12px">–ú–µ–¥–∏–∞ –≤ –∞–ª—å–±–æ–º–µ "${escapeHtml(album?.title || '')}"</h3>
        <div class="media-grid" id="albumCurrentMedia" style="margin-bottom:24px"></div>
        
        <h3 style="margin:0 0 12px">–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ–¥–∏–∞ (–∫–ª–∏–∫–Ω–∏, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å)</h3>
        <div class="media-grid" id="albumAvailableMedia"></div>
      `;
      
      // –†–µ–Ω–¥–µ—Ä–∏–º –º–µ–¥–∏–∞ –≤ –∞–ª—å–±–æ–º–µ
      const currentGrid = document.getElementById('albumCurrentMedia');
      if (inAlbum.length === 0) {
        currentGrid.innerHTML = '<p class="small" style="color:#888">–í –∞–ª—å–±–æ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –º–µ–¥–∏–∞</p>';
      } else {
        currentGrid.innerHTML = inAlbum.map(media => renderMediaThumb(media, true, albumId)).join('');
      }
      
      // –†–µ–Ω–¥–µ—Ä–∏–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ–¥–∏–∞
      const availableGrid = document.getElementById('albumAvailableMedia');
      if (notInAlbum.length === 0) {
        availableGrid.innerHTML = '<p class="small" style="color:#888">–í—Å–µ –º–µ–¥–∏–∞ —É–∂–µ –≤ –∞–ª—å–±–æ–º–∞—Ö</p>';
      } else {
        availableGrid.innerHTML = notInAlbum.map(media => renderMediaThumb(media, false, albumId)).join('');
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      document.querySelectorAll('.media-add-to-album').forEach(btn => {
        btn.addEventListener('click', async () => {
          await addMediaToAlbum(btn.dataset.mediaId, albumId);
          await loadAlbumMedia(albumId);
        });
      });
      
      document.querySelectorAll('.media-remove-from-album').forEach(btn => {
        btn.addEventListener('click', async () => {
          await removeMediaFromAlbum(btn.dataset.mediaId);
          await loadAlbumMedia(albumId);
        });
      });
    }
    
    // –†–µ–Ω–¥–µ—Ä –º–∏–Ω–∏–∞—Ç—é—Ä—ã –º–µ–¥–∏–∞
    function renderMediaThumb(media, isInAlbum, albumId) {
      const isVideo = media.media_type === 'video';
      const url = media.url || '';
      
      return `
        <div class="media-item" style="position:relative;border:1px solid #e5e5e5;border-radius:8px;overflow:hidden">
          ${isVideo 
            ? `<video src="${url}" style="width:100%;height:150px;object-fit:cover;display:block" muted playsinline></video>`
            : `<img src="${url}" alt="" style="width:100%;height:150px;object-fit:cover;display:block">`
          }
          ${isInAlbum 
            ? `<button class="btn media-remove-from-album" data-media-id="${media.id}" 
                 style="position:absolute;top:8px;right:8px;background:#ef4444;color:#fff;padding:6px 12px;font-size:12px;border:none;border-radius:6px;cursor:pointer">
                 –£–±—Ä–∞—Ç—å
               </button>`
            : `<button class="btn media-add-to-album" data-media-id="${media.id}" 
                 style="position:absolute;top:8px;right:8px;background:#10b981;color:#fff;padding:6px 12px;font-size:12px;border:none;border-radius:6px;cursor:pointer">
                 –î–æ–±–∞–≤–∏—Ç—å
               </button>`
          }
        </div>
      `;
    }
    
    // –î–æ–±–∞–≤–∏—Ç—å –º–µ–¥–∏–∞ –≤ –∞–ª—å–±–æ–º
    async function addMediaToAlbum(mediaId, albumId) {
      const { error } = await sb
        .from('expert_media')
        .update({ album_id: albumId })
        .eq('id', mediaId);
      
      if (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
        return;
      }
      
      status.textContent = '‚úÖ –ú–µ–¥–∏–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∞–ª—å–±–æ–º';
    }
    
    // –£–±—Ä–∞—Ç—å –º–µ–¥–∏–∞ –∏–∑ –∞–ª—å–±–æ–º–∞
    async function removeMediaFromAlbum(mediaId) {
      const { error } = await sb
        .from('expert_media')
        .update({ album_id: null })
        .eq('id', mediaId);
      
      if (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
        return;
      }
      
      status.textContent = '‚úÖ –ú–µ–¥–∏–∞ —É–±—Ä–∞–Ω–æ –∏–∑ –∞–ª—å–±–æ–º–∞';
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    await loadAlbums();
  });

})();
</script> <!-- nominify end --><script type="text/javascript">window.dataLayer=window.dataLayer||[];</script> <script type="text/javascript">(function() {if((/bot|google|yandex|baidu|bing|msn|duckduckbot|teoma|slurp|crawler|spider|robot|crawling|facebook/i.test(navigator.userAgent))===false&&typeof(sessionStorage)!='undefined'&&sessionStorage.getItem('visited')!=='y'&&document.visibilityState){var style=document.createElement('style');style.type='text/css';style.innerHTML='@media screen and (min-width: 980px) {.t-records {opacity: 0;}.t-records_animated {-webkit-transition: opacity ease-in-out .2s;-moz-transition: opacity ease-in-out .2s;-o-transition: opacity ease-in-out .2s;transition: opacity ease-in-out .2s;}.t-records.t-records_visible {opacity: 1;}}';document.getElementsByTagName('head')[0].appendChild(style);function t_setvisRecs(){var alr=document.querySelectorAll('.t-records');Array.prototype.forEach.call(alr,function(el) {el.classList.add("t-records_animated");});setTimeout(function() {Array.prototype.forEach.call(alr,function(el) {el.classList.add("t-records_visible");});sessionStorage.setItem("visited","y");},400);}
document.addEventListener('DOMContentLoaded',t_setvisRecs);}})();</script><script id="ai-remove-tilda">
(function(){
  function rm(){
    try{
      var el = document.getElementById("tildacopy");
      if(el) el.remove();
      document.querySelectorAll(".t-tildalabel").forEach(function(x){
        try{ x.remove(); }catch(e){}
      });
    }catch(e){}
  }
  try{
    var mo = new MutationObserver(function(){ rm(); });
    mo.observe(document.documentElement, { childList:true, subtree:true });
  }catch(e){}
  rm();
  document.addEventListener("DOMContentLoaded", rm);
  window.addEventListener("load", rm);
  setTimeout(rm, 50);
  setTimeout(rm, 250);
})();
</script><style id="ai-logo-css">
  /* –õ–û–ì–û: /images/ai-logo.png + –∑–∞–ø–∞—Å–Ω–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
  .nav a.brand{
    display:flex !important;
    align-items:center !important;
    gap:10px !important;
    text-decoration:none !important;
  }
  .nav a.brand .logo{
    width: 36px !important;
    height: 36px !important;
    flex: 0 0 auto !important;
    border-radius: 999px !important;
    background:
      url("/images/ai-logo.png") center / cover no-repeat,
      linear-gradient(135deg, #1E78FF 0%, #00B7FF 100%) !important;
  }

  /* –ú–æ–±–∏–ª—å–Ω—ã–π —Ö–µ–¥–µ—Ä: –ª–æ–≥–æ—Ç–∏–ø –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω, –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å */
  @media (max-width: 560px){
    .nav a.brand{ flex: 0 0 auto !important; min-width: auto !important; }
    /* —Å–∫—Ä—ã–≤–∞–µ–º –ª—é–±–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π span –≤–Ω—É—Ç—Ä–∏ –±—Ä–µ–Ω–¥–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ .logo) */
    .nav a.brand span:not(.logo){
      display:none !important;
    }
    .nav a.brand .logo{
      width: 34px !important;
      height: 34px !important;
    }
    .nav .nav-cta{
      flex-wrap: wrap !important;
      justify-content: flex-end;
    }
  }
</style><script id="ai-mobile-brand-hide">
(function(){
  function apply(){
    try{
      var isMobile = window.matchMedia && window.matchMedia('(max-width: 560px)').matches;
      var nodes = document.querySelectorAll('.nav a.brand span:not(.logo)');
      nodes.forEach(function(sp){
        try{
          if(isMobile) sp.style.setProperty('display','none','important');
          else sp.style.removeProperty('display');
        }catch(e){}
      });
    }catch(e){}
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', apply);
  else apply();
  window.addEventListener('resize', apply);
  setTimeout(apply, 200);
  setTimeout(apply, 900);
})();
</script></head> <body class="t-body" style="margin:0;"> <!--allrecords--> <div id="allrecords" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="13172919" data-tilda-page-id="103811936" data-tilda-page-alias="add" data-tilda-formskey="77f9e6caf19eb935e0f8ff1513172919" data-tilda-cookie="no" data-tilda-lazy="yes" data-tilda-root-zone="com" data-tilda-project-headcode="yes" data-tilda-project-country="RU"> <div id="rec1689498121" class="r t-rec" style=" " data-animationappear="off" data-record-type="131"> <!-- T123 --> <div class="t123"> <div class="t-container_100 "> <div class="t-width t-width_100 "> <!-- nominify begin --> <!-- ====== /add ‚Ä¢ –∫–∞–±–∏–Ω–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (NO MODERATION) ====== --> <script>
(async function(){
  async function waitSb(){
    for(let i=0;i<40;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r => setTimeout(r,150));
    }
    return null;
  }
  const sb = await waitSb();
  if(!sb) return;

  const { data } = await sb.auth.getSession();
  const user = data?.session?.user;

  if(!user){
    const here = location.pathname + location.search + location.hash;
    location.replace("/auth?redirect=" + encodeURIComponent(here));
  }
})();
</script> <header class="nav"> <div class="container nav-inner"> <a class="brand" href="/"> <span class="logo" aria-hidden="true"></span> <span>AI-–ë–∏—Ä–∂–∞ (MVP)</span> </a> <nav class="nav-links" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è"> <a href="/services">–£—Å–ª—É–≥–∏</a> <a href="/experts">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</a> <a href="/cases">–ö–µ–π—Å—ã</a> <a href="/how">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</a> <a href="/faq">FAQ</a> </nav> <div class="nav-cta"> <a class="btn" href="/experts">–í –∫–∞—Ç–∞–ª–æ–≥</a> <a class="btn primary" href="/apply">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</a> </div> </div> </header> <main> <section class="section"> <div class="container"> <div class="h-card"> <div class="h-eyebrow">–ö–∞–±–∏–Ω–µ—Ç</div> <h1 class="h-title" style="font-size:34px;margin-bottom:8px">–î–æ–±–∞–≤–∏—Ç—å / –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</h1> <p class="h-sub">–ú–æ–¥–µ—Ä–∞—Ü–∏–∏ –Ω–µ—Ç: –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.</p> <div class="two"> <div class="form"> <div class="field"> <label>–ò–º—è / –ù–∏–∫</label> <input id="f_name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–µ–∫—Å–µ–π" /> </div> <div class="field"> <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label> <select id="f_category"> <option value="video">AI-–í–∏–¥–µ–æ</option> <option value="design">AI-–î–∏–∑–∞–π–Ω</option> <option value="bots">AI-–ë–æ—Ç—ã</option> <option value="marketplaces">WB/Ozon</option> <option value="sites">AI-–°–∞–π—Ç—ã</option> </select> </div> <div class="field"> <label>–†–æ–ª—å / —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (—Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label> <input id="f_role" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: reels, –º–æ–Ω—Ç–∞–∂, —Å—É–±—Ç–∏—Ç—Ä—ã, –æ–∑–≤—É—á–∫–∞" /> <div class="small">–ü–∏—à–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é ‚Äî –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –ø–æ–∫–∞–∂–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –ø–ª–∞—à–∫–∞–º–∏.</div> </div> <div class="field"> <label>–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤ –ø—Ä–µ–≤—å—é –∫–∞—Ä—Ç–æ—á–∫–∏)</label> <textarea id="f_short" placeholder="1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –¥–µ–ª—É."></textarea> <div class="small">–°–æ–≤–µ—Ç: –∫–æ—Ä–æ—Ç–∫–æ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –±–µ–∑ –≤–æ–¥—ã.</div> </div> <div class="field"> <label>–û–ø–∏—Å–∞–Ω–∏–µ (–ø–æ–¥—Ä–æ–±–Ω–µ–µ)</label> <textarea id="f_desc" placeholder="–û–ø–∏—à–∏, —á—Ç–æ –¥–µ–ª–∞–µ—à—å, —Å—Ä–æ–∫–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç"></textarea> </div> <div class="two"> <div class="field"> <label>–¶–µ–Ω–∞ (–ø—Ä–∏–º–µ—Ä)</label> <input id="f_price" placeholder="–æ—Ç 15 000 ‚ÇΩ" /> </div> <div class="field"> <label>–°—Ä–æ–∫ (–ø—Ä–∏–º–µ—Ä)</label> <input id="f_time" placeholder="5‚Äì7 –¥–Ω–µ–π" /> </div> </div> <div class="field"> <label>Telegram (–¥–ª—è –∫–Ω–æ–ø–∫–∏ ‚Äú–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ‚Äù)</label> <div class="prefix-wrap"> <span class="prefix">@</span> <input id="f_tg" placeholder="username" inputmode="text" autocomplete="off" /> </div> <div class="small">–ü–∏—à–∏ —Ç–æ–ª—å–∫–æ –Ω–∏–∫. –ï—Å–ª–∏ –≤—Å—Ç–∞–≤–∏—à—å —Å—Å—ã–ª–∫—É ‚Äî —è —Å–∞–º –≤—ã—Ç–∞—â—É –Ω–∏–∫.</div> </div> <div class="two"> <div class="field"> <label>Instagram</label> <input id="f_ig" placeholder="@username –∏–ª–∏ https://instagram.com/username" /> </div> <div class="field"> <label>–°–∞–π—Ç</label> <input id="f_site" placeholder="site.ru –∏–ª–∏ https://site.ru" /> </div> </div> <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px"> <button class="btn primary" id="btnSave" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button> <button class="btn" id="btnLogout" type="button">–í—ã–π—Ç–∏</button> </div> <div class="small" id="saveMsg" style="margin-top:8px"></div> </div> <div class="form"> <h2 class="section-title" style="margin:0 0 8px">–ú–µ–¥–∏–∞</h2> <p class="section-sub" style="margin:0 0 10px">–ó–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –∏ –≤—ã–±–µ—Ä–∏ –ø—Ä–µ–≤—å—é.</p> <div class="field"> <label>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</label> <input id="mediaInput" type="file" multiple accept="image/*,video/*" /> <div class="small">–ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤.</div> </div> <div style="display:flex;gap:10px;flex-wrap:wrap"> <button class="btn primary" id="btnUpload" type="button">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button> <button class="btn" id="btnRefresh" type="button">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button> </div> <hr class="sep"> <div class="small" style="margin-bottom:8px">–ù–∞–∂–º–∏ ‚Äú–°–¥–µ–ª–∞—Ç—å –ø—Ä–µ–≤—å—é‚Äù ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–µ—Ç –æ–±–ª–æ–∂–∫–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏.</div> <div class="media-grid" id="mediaGrid"></div> <div class="small" id="mediaMsg" style="margin-top:10px"></div> </div> </div> </div> </div> </section> </main> <style>
/* –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å–∏–Ω–µ–π */
.btn.primary, .btn.primary *{ color:#fff !important; -webkit-text-fill-color:#fff !important; }

.prefix-wrap{ position:relative; }
.prefix-wrap .prefix{
  position:absolute; left:14px; top:50%; transform:translateY(-50%);
  font-weight:900; opacity:.7;
}
.prefix-wrap input{ padding-left:30px !important; }

/* –º–µ–¥–∏–∞ */
.media-grid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:12px;
}
@media (max-width: 720px){ .media-grid{ grid-template-columns: 1fr; } }

.media-card{
  border-radius: 16px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.7);
  background: var(--surface);
  box-shadow: 10px 10px 22px rgba(163,177,198,.25), -10px -10px 22px rgba(255,255,255,.85);
  padding:10px;
}
.media-prev{
  width:100%;
  aspect-ratio: 16/10;
  border-radius: 14px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.7);
  background: rgba(255,255,255,.35);
  margin-bottom:10px;
}
.media-prev img, .media-prev video{
  width:100%;height:100%;object-fit:cover;display:block;
}
.media-row{
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;
}
.badge2{
  font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;
  background: rgba(30,120,255,.12);border:1px solid rgba(30,120,255,.22);
  color: rgba(20,40,75,.85);
}
</style> <script>
window.addEventListener('DOMContentLoaded', async function(){
  const BUCKET = "experts-media";

  function esc(s){
    return String(s || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  async function waitSb(){
    for(let i=0;i<60;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r => setTimeout(r,150));
    }
    return null;
  }

  function normTagsCSV(s){
    const arr = String(s||"").split(",").map(x=>x.trim()).filter(Boolean);
    return arr.join(", ");
  }

  function extractUsernameFromUrl(url){
    const u = String(url||"").trim();
    // t.me/username –∏–ª–∏ https://t.me/username
    const m = u.match(/(?:t\.me|telegram\.me)\/([A-Za-z0-9_]{3,})/i);
    if(m && m[1]) return m[1];
    return "";
  }

  function normTelegram(input){
    let v = String(input||"").trim();
    if(!v) return "";
    // –µ—Å–ª–∏ –¥–∞–ª–∏ —Å—Å—ã–ª–∫—É
    if(v.includes("t.me/") || v.includes("telegram.me/")){
      const u = extractUsernameFromUrl(v);
      if(u) return "@"+u;
    }
    v = v.replace(/^@+/, "").trim();
    // –≤—ã–∫–∏–¥—ã–≤–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
    v = v.replace(/\s+/g,"");
    return v ? "@"+v : "";
  }

  function normInstagram(input){
    let v = String(input||"").trim();
    if(!v) return "";
    // –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É
    if(/^https?:\/\//i.test(v)) return v;
    v = v.replace(/^@+/, "").trim().replace(/\s+/g,"");
    return v ? ("https://www.instagram.com/"+v+"/") : "";
  }

  function displayInstagram(v){
    v = String(v||"").trim();
    const m = v.match(/instagram\.com\/([A-Za-z0-9_.]+)/i);
    if(m && m[1]) return "@"+m[1].replace(/\/.*/,"");
    return v;
  }

  function normWebsite(input){
    let v = String(input||"").trim();
    if(!v) return "";
    if(/^https?:\/\//i.test(v)) return v;
    return "https://"+v;
  }

  function displayTelegramUsername(v){
    v = String(v||"").trim();
    if(!v) return "";
    if(v.includes("t.me/") || v.includes("telegram.me/")) {
      const u = extractUsernameFromUrl(v);
      return u || "";
    }
    return v.replace(/^@+/, "");
  }

  const sb = await waitSb();
  const saveMsg  = document.getElementById('saveMsg');
  const mediaMsg = document.getElementById('mediaMsg');
  const grid     = document.getElementById('mediaGrid');

  if(!sb){ saveMsg.textContent = "Supabase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω."; return; }

  const { data: authData } = await sb.auth.getUser();
  const user = authData?.user;
  if(!user){ saveMsg.textContent = "–¢—ã –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω. –û—Ç–∫—Ä–æ–π /auth –∏ –≤–æ–π–¥–∏."; return; }

  let myExpert = null;

  async function loadMyCard(){
    const { data, error } = await sb
      .from("experts")
      .select("id, user_id, name, category, role, short_info, description, price_from, delivery_time, telegram, instagram, website, cover_path, cover_type, status, created_at")
      .eq("user_id", user.id)
      .order("created_at", { ascending:false })
      .limit(1);

    if(error){ saveMsg.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–∫–∏: " + error.message; return; }
    myExpert = (data && data[0]) ? data[0] : null;

    if(myExpert){
      document.getElementById('f_name').value = myExpert.name || "";
      document.getElementById('f_category').value = myExpert.category || "video";
      document.getElementById('f_role').value = myExpert.role || "";
      document.getElementById('f_short').value = myExpert.short_info || "";
      document.getElementById('f_desc').value = myExpert.description || "";
      document.getElementById('f_price').value = myExpert.price_from || "";
      document.getElementById('f_time').value = myExpert.delivery_time || "";
      document.getElementById('f_tg').value = displayTelegramUsername(myExpert.telegram || "");
      document.getElementById('f_ig').value = displayInstagram(myExpert.instagram || "");
      document.getElementById('f_site').value = myExpert.website || "";
      saveMsg.innerHTML = '–ö–∞—Ä—Ç–æ—á–∫–∞ –µ—Å—Ç—å. –°—Ç–∞—Ç—É—Å: <b>' + esc(myExpert.status || 'approved') + '</b>';
    } else {
      saveMsg.textContent = "–ö–∞—Ä—Ç–æ—á–∫–∏ –µ—â—ë –Ω–µ—Ç ‚Äî –∑–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–º–∏ ‚Äú–°–æ—Ö—Ä–∞–Ω–∏—Ç—å‚Äù.";
    }
  }

  // –∞–≤—Ç–æ–ø–æ–¥—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
  document.getElementById('f_role').addEventListener('blur', function(){
    this.value = normTagsCSV(this.value);
  });
  document.getElementById('f_tg').addEventListener('blur', function(){
    this.value = displayTelegramUsername(normTelegram(this.value));
  });
  document.getElementById('f_ig').addEventListener('blur', function(){
    const normalized = normInstagram(this.value);
    this.value = displayInstagram(normalized);
  });
  document.getElementById('f_site').addEventListener('blur', function(){
    const normalized = normWebsite(this.value);
    this.value = normalized;
  });

  async function saveCard(){
    const payload = {
      user_id: user.id,
      name: document.getElementById('f_name').value.trim(),
      category: document.getElementById('f_category').value,
      role: normTagsCSV(document.getElementById('f_role').value),
      short_info: document.getElementById('f_short').value.trim(),
      description: document.getElementById('f_desc').value.trim(),
      price_from: document.getElementById('f_price').value.trim(),
      delivery_time: document.getElementById('f_time').value.trim(),
      telegram: normTelegram(document.getElementById('f_tg').value),
      instagram: normInstagram(document.getElementById('f_ig').value),
      website: normWebsite(document.getElementById('f_site').value),
      status: "approved"
    };

    if(!payload.name){ saveMsg.textContent = "–ó–∞–ø–æ–ª–Ω–∏ –∏–º—è/–Ω–∏–∫."; return; }

    if(myExpert && myExpert.id){
      const { error } = await sb.from("experts").update(payload).eq("id", myExpert.id);
      if(error){ saveMsg.textContent = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + error.message; return; }
      saveMsg.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ —Å—Ä–∞–∑—É –≤–∏–¥–Ω–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.";
    } else {
      const { data, error } = await sb.from("experts").insert(payload).select("id").single();
      if(error){ saveMsg.textContent = "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: " + error.message; return; }
      myExpert = { id: data.id, ...payload };
      saveMsg.textContent = "–ì–æ—Ç–æ–≤–æ ‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å—Ä–∞–∑—É –≤–∏–¥–Ω–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.";
    }

    await loadMyCard();
    await loadMedia();
  }

  async function loadMedia(){
    grid.innerHTML = "";
    if(!myExpert || !myExpert.id){ mediaMsg.textContent = "–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É."; return; }

    mediaMsg.textContent = "–ó–∞–≥—Ä—É–∂–∞—é –º–µ–¥–∏–∞...";
    const { data, error } = await sb
      .from("expert_media")
      .select("id, media_type, storage_path, created_at")
      .eq("expert_id", myExpert.id)
      .order("created_at", { ascending:false });

    if(error){ mediaMsg.textContent = "–û—à–∏–±–∫–∞ –º–µ–¥–∏–∞: " + error.message; return; }
    if(!data || data.length===0){ mediaMsg.textContent = "–ü–æ–∫–∞ –º–µ–¥–∏–∞ –Ω–µ—Ç."; return; }

    const paths = data.map(m => m.storage_path);
    const { data: urls } = await sb.storage.from(BUCKET).createSignedUrls(paths, 60*60);
    const urlByPath = new Map();
    (urls || []).forEach(x => { if(x?.path && x?.signedUrl) urlByPath.set(x.path, x.signedUrl); });

    grid.innerHTML = data.map(m => {
      const u = urlByPath.get(m.storage_path);
      const isCover = (myExpert.cover_path && myExpert.cover_path === m.storage_path);
      return `
       <div class="media-prev ${m.media_type==="video" ? "is-video" : ""}">
  ${m.media_type==="video"
    ? `<video src="${u}" controls muted playsinline preload="metadata"></video>`
    : `<img src="${u}" alt="">`
  }
</div> <div class="media-row"> <span class="badge2">${isCover ? "PREVIEW ‚úÖ" : (m.media_type==="video" ? "–í–∏–¥–µ–æ" : "–§–æ—Ç–æ")}</span> <div style="display:flex;gap:8px;flex-wrap:wrap"> <button class="btn primary" type="button" data-setcover="${esc(m.storage_path)}" data-type="${esc(m.media_type)}">–°–¥–µ–ª–∞—Ç—å –ø—Ä–µ–≤—å—é</button> <button class="btn" type="button" data-del="${esc(m.id)}">–£–¥–∞–ª–∏—Ç—å</button> </div> </div> </div>
      `;
    }).join("");

    grid.querySelectorAll("[data-setcover]").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        const path = btn.getAttribute("data-setcover");
        const type = btn.getAttribute("data-type");
        const { error } = await sb.from("experts")
          .update({ cover_path: path, cover_type: type })
          .eq("id", myExpert.id);

        if(error){ mediaMsg.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–µ–≤—å—é: " + error.message; return; }
        mediaMsg.textContent = "–ü—Ä–µ–≤—å—é –æ–±–Ω–æ–≤–ª–µ–Ω–æ ‚úÖ";
        await loadMyCard();
        await loadMedia();
      });
    });

    grid.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        const mediaId = btn.getAttribute("data-del");

        const { data: row, error: rerr } = await sb
          .from("expert_media")
          .select("id, storage_path")
          .eq("id", mediaId)
          .single();

        if(rerr){ mediaMsg.textContent = "–û—à–∏–±–∫–∞: " + rerr.message; return; }

        await sb.storage.from(BUCKET).remove([row.storage_path]);
        const { error: derr } = await sb.from("expert_media").delete().eq("id", mediaId);
        if(derr){ mediaMsg.textContent = "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + derr.message; return; }

        if(myExpert.cover_path === row.storage_path){
          await sb.from("experts").update({ cover_path: null, cover_type: null }).eq("id", myExpert.id);
        }

        mediaMsg.textContent = "–£–¥–∞–ª–µ–Ω–æ ‚úÖ";
        await loadMyCard();
        await loadMedia();
      });
    });

    mediaMsg.textContent = "";
  }

  async function uploadMedia(){
    const ui = ensureUploadUi();

    if(!myExpert || !myExpert.id){
      mediaMsg.textContent = "–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É.";
      ui.setFiles([]);
      ui.setProgress(0);
      ui.setState("error");
      ui.setSummary("–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É, –ø–æ—Ç–æ–º –∑–∞–≥—Ä—É–∂–∞–π —Ñ–∞–π–ª—ã.");
      return;
    }

    const input = document.getElementById('mediaInput');
    const files = Array.from(input.files || []);
    if(files.length===0){
      mediaMsg.textContent = "–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª—ã.";
      ui.setFiles([]);
      ui.setProgress(0);
      ui.setState("error");
      ui.setSummary("–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª—ã ‚Äî –∏ –Ω–∞–∂–º–∏ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª –µ—â—ë —Ä–∞–∑.");
      return;
    }

    // UI –∑–∞–≥—Ä—É–∑–∫–∏ (—á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª –ø—Ä–æ—Ü–µ—Å—Å)
    ui.setState("running");
    ui.setSummary(`–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶ (0/${files.length})`);
    ui.setProgress(0);
    ui.setFiles(files);

    const btn = document.getElementById('btnUpload');
    if(btn) btn.disabled = true;
    input.disabled = true;

    mediaMsg.textContent = "";

    let done = 0;
    try{
      for(let idx = 0; idx < files.length; idx++){
        const file = files[idx];
        ui.setFileStatus(idx, "uploading", "–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶");
        ui.setSummary(`–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶ (${done}/${files.length})`);
        ui.setProgress(Math.round((done / files.length) * 100));

        const isVideo = file.type.startsWith("video/");
        const ext = (file.name.split(".").pop() || (isVideo ? "mp4" : "jpg")).toLowerCase();
        const path = `experts/${myExpert.id}/${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;

        const { error: uerr } = await sb.storage.from(BUCKET).upload(path, file, { upsert:false });
        if(uerr){
          ui.setFileStatus(idx, "error", "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + uerr.message);
          throw new Error(uerr.message);
        }

        const { error: ierr } = await sb.from("expert_media").insert({
          user_id: user.id,
          expert_id: myExpert.id,
          media_type: isVideo ? "video" : "image",
          storage_path: path
        });

        if(ierr){
          // —á—Ç–æ–±—ã –Ω–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å "–≤–∏—Å—è—â–∏–π" —Ñ–∞–π–ª –≤ storage
          try{ await sb.storage.from(BUCKET).remove([path]); } catch(_e){}
          ui.setFileStatus(idx, "error", "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: " + ierr.message);
          throw new Error(ierr.message);
        }

        done++;
        ui.setFileStatus(idx, "done", "–ì–æ—Ç–æ–≤–æ ‚úÖ");
        ui.setSummary(`–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶ (${done}/${files.length})`);
        ui.setProgress(Math.round((done / files.length) * 100));
      }

      ui.setProgress(100);
      ui.setSummary(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ‚úÖ (${done}/${files.length})`);
      ui.setState("done");

      input.value = "";
      await loadMyCard();
      await loadMedia();
    } catch(e){
      ui.setState("error");
      ui.setSummary(`–û—à–∏–±–∫–∞. –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${done}/${files.length}`);
      mediaMsg.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + (e?.message || e);
    } finally {
      if(btn) btn.disabled = false;
      input.disabled = false;
    }
  }

  function ensureUploadUi(){
    let root = document.getElementById('uploadUi');
    if(root) return root._api;

    const btn = document.getElementById('btnUpload');
    const mount = btn?.parentElement || btn;
    root = document.createElement('div');
    root.id = 'uploadUi';
    root.className = 'upload-ui';
    root.innerHTML = `
      <div class="upload-ui__top">
        <div class="upload-ui__left">
          <span class="upload-ui__spin" aria-hidden="true"></span>
          <div class="upload-ui__summary" id="uploadUiSummary">–ì–æ—Ç–æ–≤–æ</div>
        </div>
        <button class="upload-ui__hide" type="button" id="uploadUiHide">–°–≤–µ—Ä–Ω—É—Ç—å</button>
      </div>
      <div class="upload-ui__bar" aria-hidden="true">
        <div class="upload-ui__barFill" id="uploadUiBar"></div>
      </div>
      <div class="upload-ui__list" id="uploadUiList"></div>
    `;

    // –≤—Å—Ç–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å"
    if(btn) btn.insertAdjacentElement('afterend', root);
    else if(mount) mount.appendChild(root);

    const hideBtn = root.querySelector('#uploadUiHide');
    if(hideBtn){
      hideBtn.addEventListener('click', () => {
        root.classList.toggle('is-collapsed');
        hideBtn.textContent = root.classList.contains('is-collapsed') ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" : "–°–≤–µ—Ä–Ω—É—Ç—å";
      });
    }

    const summaryEl = root.querySelector('#uploadUiSummary');
    const barEl = root.querySelector('#uploadUiBar');
    const listEl = root.querySelector('#uploadUiList');

    const api = {
      setState(state){
        root.classList.remove('is-running','is-done','is-error');
        if(state === 'running') root.classList.add('is-running');
        if(state === 'done') root.classList.add('is-done');
        if(state === 'error') root.classList.add('is-error');
        root.style.display = '';
      },
      setSummary(text){
        if(summaryEl) summaryEl.textContent = text || '';
      },
      setProgress(pct){
        const v = Math.max(0, Math.min(100, Number(pct) || 0));
        if(barEl) barEl.style.width = v + '%';
      },
      setFiles(files){
        if(!listEl) return;
        listEl.innerHTML = (files || []).map((f, i) => {
          const size = formatBytes(f.size || 0);
          return `
            <div class="upload-ui__row" data-i="${i}">
              <div class="upload-ui__name">${esc(f.name || 'file')}</div>
              <div class="upload-ui__meta">${size}</div>
              <div class="upload-ui__status is-queued">–í –æ—á–µ—Ä–µ–¥–∏</div>
            </div>
          `;
        }).join('');
      },
      setFileStatus(idx, kind, text){
        if(!listEl) return;
        const row = listEl.querySelector(`.upload-ui__row[data-i="${idx}"]`);
        if(!row) return;
        const st = row.querySelector('.upload-ui__status');
        if(!st) return;
        st.classList.remove('is-queued','is-uploading','is-done','is-error');
        if(kind === 'queued') st.classList.add('is-queued');
        if(kind === 'uploading') st.classList.add('is-uploading');
        if(kind === 'done') st.classList.add('is-done');
        if(kind === 'error') st.classList.add('is-error');
        st.textContent = text || '';
      }
    };

    root._api = api;
    return api;
  }

  function formatBytes(bytes){
    const b = Number(bytes) || 0;
    if(b < 1024) return b + ' B';
    const kb = b / 1024;
    if(kb < 1024) return kb.toFixed(1) + ' KB';
    const mb = kb / 1024;
    if(mb < 1024) return mb.toFixed(1) + ' MB';
    const gb = mb / 1024;
    return gb.toFixed(2) + ' GB';
  }

  document.getElementById('btnSave').addEventListener('click', saveCard);
  document.getElementById('btnUpload').addEventListener('click', uploadMedia);
  document.getElementById('btnRefresh').addEventListener('click', loadMedia);
  document.getElementById('btnLogout').addEventListener('click', async () => {
    await sb.auth.signOut();
    location.reload();
  });

  await loadMyCard();
  await loadMedia();
});
</script> <style>
/* ===== Adaptive media preview (9:16 / 16:9 / 1:1) ===== */

/* –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π 16:10 */
.media-card .media-prev{
  aspect-ratio: 16 / 9;        /* –¥–µ—Ñ–æ–ª—Ç: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ */
  height: auto !important;
  max-height: 560px;           /* —á—Ç–æ–±—ã –≤–µ—Ä—Ç–∏–∫–∞–ª–∫–∞ –Ω–µ —É—Ö–æ–¥–∏–ª–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –≤–Ω–∏–∑ */
  background: #000;            /* –∫—Ä–∞—Å–∏–≤—ã–µ –ø–æ–ª—è –¥–ª—è contain */
}

/* –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ */
.media-card .media-prev.ratio-portrait{ aspect-ratio: 9 / 16; }
.media-card .media-prev.ratio-landscape{ aspect-ratio: 16 / 9; }
.media-card .media-prev.ratio-square{ aspect-ratio: 1 / 1; }

/* –í–ê–ñ–ù–û: –ù–ï –†–ï–ñ–ï–ú */
.media-card .media-prev video,
.media-card .media-prev img{
  width: 100% !important;
  height: 100% !important;
  object-fit: contain !important; /* –Ω–µ –æ–±—Ä–µ–∑–∞–µ—Ç */
  display: block;
  background: #000;
}

/* ===== UI –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ (–ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∏–¥—ë—Ç) ===== */
.upload-ui{
  margin-top: 10px;
  padding: 12px;
  border-radius: 16px;
  border:1px solid rgba(255,255,255,.7);
  background: rgba(245,248,252,.92);
  box-shadow: 10px 10px 22px rgba(163,177,198,.25), -10px -10px 22px rgba(255,255,255,.85);
  display:none; /* –≤–∫–ª—é—á–∞–µ–º, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ */
}
.upload-ui.is-running,
.upload-ui.is-done,
.upload-ui.is-error{ display:block; }

.upload-ui__top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:10px;
}
.upload-ui__left{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
.upload-ui__summary{
  font-weight:900;
  color: rgba(19,35,63,.92);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.upload-ui__hide{
  border:1px solid rgba(255,255,255,.75);
  background: rgba(238,243,250,.9);
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
  font-weight:800;
}

.upload-ui__spin{
  width:16px;height:16px;
  border-radius:50%;
  border:2px solid rgba(19,35,63,.18);
  border-top-color: rgba(30,120,255,.9);
  display:inline-block;
}
.upload-ui.is-running .upload-ui__spin{
  animation: uploadSpin .9s linear infinite;
}
.upload-ui.is-done .upload-ui__spin{
  border-color: rgba(34,197,94,.22);
  border-top-color: rgba(34,197,94,.9);
}
.upload-ui.is-error .upload-ui__spin{
  border-color: rgba(239,68,68,.22);
  border-top-color: rgba(239,68,68,.9);
}
@keyframes uploadSpin{ to { transform: rotate(360deg); } }

.upload-ui__bar{
  width:100%;
  height:10px;
  border-radius:999px;
  overflow:hidden;
  background: rgba(19,35,63,.10);
  border:1px solid rgba(255,255,255,.7);
  margin-bottom:10px;
}
.upload-ui__barFill{
  width:0%;
  height:100%;
  background: linear-gradient(90deg, #1e78ff, #00b7ff);
  border-radius:999px;
  transition: width .25s ease;
}

.upload-ui__list{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.upload-ui__row{
  display:grid;
  grid-template-columns: 1fr auto auto;
  gap:10px;
  align-items:center;
  padding:10px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.75);
  background: rgba(255,255,255,.65);
}
.upload-ui__name{
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  font-weight:800;
  color: rgba(19,35,63,.9);
}
.upload-ui__meta{
  font-size:12px;
  color: rgba(19,35,63,.55);
  white-space:nowrap;
}
.upload-ui__status{
  font-size:12px;
  font-weight:900;
  white-space:nowrap;
}
.upload-ui__status.is-queued{ color: rgba(19,35,63,.55); }
.upload-ui__status.is-uploading{ color: rgba(30,120,255,.95); }
.upload-ui__status.is-done{ color: rgba(34,197,94,.95); }
.upload-ui__status.is-error{ color: rgba(239,68,68,.95); }

.upload-ui.is-collapsed .upload-ui__bar,
.upload-ui.is-collapsed .upload-ui__list{ display:none; }

@media (max-width: 560px){
  .upload-ui__row{ grid-template-columns: 1fr auto; grid-template-areas:
    "name status"
    "meta meta";
  }
  .upload-ui__name{ grid-area:name; }
  .upload-ui__status{ grid-area:status; justify-self:end; }
  .upload-ui__meta{ grid-area:meta; }
}
</style> <script>
(function(){
  function applyRatio(prev, w, h){
    if(!w || !h) return;

    prev.classList.remove("ratio-portrait","ratio-landscape","ratio-square");

    const r = w / h;

    // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ
    if (r > 1.15){
      prev.classList.add("ratio-landscape");
      prev.style.aspectRatio = "16 / 9";
      return;
    }

    // –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ
    if (r < 0.87){
      prev.classList.add("ratio-portrait");
      prev.style.aspectRatio = "9 / 16";
      return;
    }

    // –ø–æ—á—Ç–∏ –∫–≤–∞–¥—Ä–∞—Ç
    prev.classList.add("ratio-square");
    prev.style.aspectRatio = "1 / 1";
  }

  function initPrev(prev){
    if(!prev || prev.dataset.ratioInit) return;
    prev.dataset.ratioInit = "1";

    const v = prev.querySelector("video");
    const img = prev.querySelector("img");

    if(v){
      const run = () => applyRatio(prev, v.videoWidth, v.videoHeight);
      if(v.readyState >= 1) run();
      else v.addEventListener("loadedmetadata", run, { once:true });
      return;
    }

    if(img){
      const run = () => applyRatio(prev, img.naturalWidth, img.naturalHeight);
      if(img.complete) run();
      else img.addEventListener("load", run, { once:true });
    }
  }

  function scan(){
    document.querySelectorAll(".media-card .media-prev").forEach(initPrev);
  }

  document.addEventListener("DOMContentLoaded", function(){
    scan();

    // –ª—ë–≥–∫–∏–π observer –¢–û–õ–¨–ö–û –Ω–∞ #mediaGrid (–Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç —Å–∞–π—Ç)
    const grid = document.getElementById("mediaGrid");
    if(!grid) return;

    const mo = new MutationObserver(() => scan());
    mo.observe(grid, { childList:true, subtree:true });
  });
})();
</script> <!-- FIX: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –≤–∏–¥–µ–æ –Ω–µ —Ä–µ–∂–µ–º, –¥–µ–ª–∞–µ–º 9:16 / 16:9 –∞–≤—Ç–æ --> <style>
/* –°–ò–õ–¨–ù–û–ï –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –∏–º–µ–Ω–Ω–æ –¥–ª—è –ø—Ä–µ–≤—å—é –º–µ–¥–∏–∞ */
#allrecords #mediaGrid video,
.t-records #mediaGrid video,
#allrecords .media-prev video,
.t-records .media-prev video,
#allrecords .media-preview video,
.t-records .media-preview video{
  object-fit: contain !important;
  width: 100% !important;
  height: 100% !important;
  background:#000 !important;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–µ–≤—å—é ‚Äî –ø—É—Å—Ç—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω—É–∂–Ω—ã–π ratio */
#allrecords #mediaGrid .media-prev,
.t-records #mediaGrid .media-prev,
#allrecords .media-prev,
.t-records .media-prev,
#allrecords .media-preview,
.t-records .media-preview{
  background:#000 !important;
  height:auto !important;
  max-height:560px !important;
}
</style> <script>
(function(){
  function pickRatio(w,h){
    if(!w || !h) return null;
    const r = w / h;
    if(r < 0.87) return "9 / 16";     // –≤–µ—Ä—Ç–∏–∫–∞–ª–∫–∞
    if(r > 1.15) return "16 / 9";     // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∫–∞
    return "1 / 1";                  // –ø–æ—á—Ç–∏ –∫–≤–∞–¥—Ä–∞—Ç
  }

  function applyToVideo(v){
    if(!v || v.dataset.ratioFixed) return;

    const wrap =
      v.closest(".media-prev") ||
      v.closest(".media-preview") ||
      v.parentElement;

    // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, –∏–Ω–ª–∞–π–Ω–æ–º (—Å–∞–º–æ–µ —Å–∏–ª—å–Ω–æ–µ)
    v.style.objectFit = "contain";
    v.style.width = "100%";
    v.style.height = "100%";
    v.style.background = "#000";

    function set(){
      const ratio = pickRatio(v.videoWidth, v.videoHeight);
      if(!ratio) return;

      if(wrap){
        wrap.style.aspectRatio = ratio;
        wrap.style.background = "#000";
        wrap.style.height = "auto";
        wrap.style.maxHeight = "560px";
        wrap.style.overflow = "hidden"; // —á—Ç–æ–±—ã —Ä–∞–¥–∏—É—Å –Ω–µ –ª–æ–º–∞–ª—Å—è
      }

      v.dataset.ratioFixed = "1";
    }

    // –≤–∞–∂–Ω–æ: –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –≥—Ä—É–∑–∏—Ç—å—Å—è –Ω–µ —Å—Ä–∞–∑—É
    if(v.readyState >= 1) set();
    else v.addEventListener("loadedmetadata", set, { once:true });

    // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π: –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –¥–∞–ª —Ä–∞–∑–º–µ—Ä—ã —á—É—Ç—å –ø–æ–∑–∂–µ
    setTimeout(set, 300);
    setTimeout(set, 1200);
  }

  function scan(){
    // 1) –æ—Å–Ω–æ–≤–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è –≤ –∫–∞–±–∏–Ω–µ—Ç–µ
    const grid = document.getElementById("mediaGrid");
    if(grid){
      grid.querySelectorAll("video").forEach(applyToVideo);
    }
    // 2) –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –µ—Å—Ç—å –µ—â—ë –ø—Ä–µ–≤—å—é-–≤–∏–¥–µ–æ (–æ–±–ª–æ–∂–∫–∞ –∏ —Ç.–ø.)
    document.querySelectorAll(".media-prev video, .media-preview video").forEach(applyToVideo);
  }

  document.addEventListener("DOMContentLoaded", function(){
    scan();

    // –ª—ë–≥–∫–∏–π ‚Äú–¥–æ—Å–º–æ—Ç—Ä‚Äù 3 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏ (–±–µ–∑ –ª–∞–≥–æ–≤)
    let n = 0;
    const t = setInterval(function(){
      scan();
      n++;
      if(n >= 8) clearInterval(t);
    }, 400);
  });
})();
</script> <!-- FIX: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –§–û–¢–û –Ω–µ —Ä–µ–∂–µ–º (–∫–∞–∫ Reels/Shorts) --> <style>
/* –°–ò–õ–¨–ù–û–ï –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –¥–ª—è —Ñ–æ—Ç–æ –≤ –º–µ–¥–∏–∞-–ø—Ä–µ–≤—å—é */
#allrecords #mediaGrid img,
.t-records #mediaGrid img,
#allrecords .media-prev img,
.t-records .media-prev img,
#allrecords .media-preview img,
.t-records .media-preview img{
  object-fit: contain !important;
  width: 100% !important;
  height: 100% !important;
  background:#000 !important;
}
</style> <script>
(function(){
  function pickRatio(w,h){
    if(!w || !h) return null;
    const r = w / h;
    if(r < 0.87) return "9 / 16";     // –≤–µ—Ä—Ç–∏–∫–∞–ª–∫–∞
    if(r > 1.15) return "16 / 9";     // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∫–∞
    return "1 / 1";                  // –ø–æ—á—Ç–∏ –∫–≤–∞–¥—Ä–∞—Ç
  }

  function applyToImg(img){
    if(!img || img.dataset.ratioFixed) return;

    const wrap =
      img.closest(".media-prev") ||
      img.closest(".media-preview") ||
      img.parentElement;

    // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ (–∏–Ω–ª–∞–π–Ω —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ—Ö css)
    img.style.objectFit = "contain";
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.background = "#000";

    function set(){
      const ratio = pickRatio(img.naturalWidth, img.naturalHeight);
      if(!ratio) return;

      if(wrap){
        wrap.style.aspectRatio = ratio;
        wrap.style.background = "#000";
        wrap.style.height = "auto";
        wrap.style.maxHeight = "560px";
        wrap.style.overflow = "hidden";
      }

      img.dataset.ratioFixed = "1";
    }

    if(img.complete) set();
    else img.addEventListener("load", set, { once:true });

    setTimeout(set, 300);
    setTimeout(set, 1200);
  }

  function scanImages(){
    const grid = document.getElementById("mediaGrid");
    if(grid) grid.querySelectorAll("img").forEach(applyToImg);

    document.querySelectorAll(".media-prev img, .media-preview img").forEach(applyToImg);
  }

  document.addEventListener("DOMContentLoaded", function(){
    scanImages();

    // –ª—ë–≥–∫–∏–π –¥–æ–≥–æ–Ω –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã (—á—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å –¥–æ—Ä–∏—Å–æ–≤–∫—É)
    let n=0;
    const t=setInterval(function(){
      scanImages();
      n++;
      if(n>=8) clearInterval(t);
    }, 400);
  });
})();
</script> <script>
(function(){
  const AUTH_PAGE = "/auth"; // —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ Tilda
  const BTN_TEXT = "–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ";

  function findBtnByText(txt){
    const all = Array.from(document.querySelectorAll("a,button"));
    const norm = s => (s||"").replace(/\s+/g," ").trim().toLowerCase();
    const t = norm(txt);
    return all.find(el => norm(el.textContent).includes(t)) || null;
  }

  async function waitSb(){
    for(let i=0;i<40;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r=>setTimeout(r,150));
    }
    return null;
  }

  async function isAuthed(){
    const sb = await waitSb();
    if(!sb) return false;
    const { data } = await sb.auth.getSession();
    return !!data?.session?.user;
  }

  function goAuth(){
    const redirect = encodeURIComponent(location.href);
    location.href = AUTH_PAGE + "?redirect=" + redirect;
  }

  window.addEventListener("DOMContentLoaded", async () => {
    const btn = findBtnByText(BTN_TEXT);
    if(!btn) return;

    btn.addEventListener("click", async (e) => {
      const ok = await isAuthed();
      if(!ok){
        e.preventDefault();
        e.stopPropagation();
        if(e.stopImmediatePropagation) e.stopImmediatePropagation();
        goAuth();
      }
      // –µ—Å–ª–∏ ok=true ‚Äî –∫–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ (—Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏)
    }, true);
  });
})();
</script> <style>
  /* /add: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
  #allrecords .ai-add-alert{
    margin: 0 0 14px;
    padding: 14px 16px;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,.7);
    background: rgba(255,255,255,.45);
    box-shadow: 10px 10px 22px rgba(163,177,198,.22), -10px -10px 22px rgba(255,255,255,.88);
    backdrop-filter: blur(10px);
    display:flex;
    gap:12px;
    align-items:flex-start;
    justify-content:space-between;
  }
  #allrecords .ai-add-alert b{ font-weight: 900; }
  #allrecords .ai-add-alert .x{
    width:40px;height:40px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.75);
    background: rgba(238,243,250,.85);
    box-shadow: 10px 10px 22px rgba(163,177,198,.22), -10px -10px 22px rgba(255,255,255,.88);
    cursor:pointer;
    flex:0 0 auto;
    display:flex;align-items:center;justify-content:center;
    user-select:none;
  }
  #allrecords .ai-add-alert .t{
    color: rgba(19,35,63,.78);
    line-height: 1.45;
  }
  #allrecords .ai-add-alert.info{
    border-left: 6px solid rgba(0,120,255,.55);
  }
  #allrecords .ai-add-alert.ok{
    border-left: 6px solid rgba(0,200,120,.55);
  }
</style> <script>
(function(){
  async function waitSb(){
    for(let i=0;i<40;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r => setTimeout(r,150));
    }
    return null;
  }

  function findTopAnchor(){
    // –∫—É–¥–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å –ø–ª–∞—à–∫–∏: —Å—Ç–∞—Ä–∞–µ–º—Å—è –≤ —Å–∞–º—ã–π –≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    return (
      document.querySelector('main .section .container') ||
      document.querySelector('main .container') ||
      document.querySelector('.section .container') ||
      document.querySelector('.container') ||
      document.querySelector('#allrecords') ||
      document.body
    );
  }

  function makeAlert(type, html){
    const el = document.createElement('div');
    el.className = 'ai-add-alert ' + type;
    el.innerHTML = `
      <div class="t">${html}</div> <div class="x" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</div>
    `;
    el.querySelector('.x').addEventListener('click', ()=> el.remove());
    return el;
  }

  function injectOnce(id, node, anchor){
    if(document.getElementById(id)) return;
    node.id = id;
    anchor.insertBefore(node, anchor.firstChild);
  }

  window.addEventListener('DOMContentLoaded', async () => {
    const anchor = findTopAnchor();

    // 1) –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —Å–≤–µ—Ä—Ö—É /add
    const info = makeAlert(
      'info',
      `–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ, <b>–≤–ø–∏—à–∏ –¥–∞–Ω–Ω—ã–µ –æ —Å–µ–±–µ</b> –∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É <b>¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª</b>.
      –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–∑–¥–∞—Å—Ç—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞ ‚Äî –∏ —Ç–æ–≥–¥–∞ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –º–µ–¥–∏–∞.`
    );
    injectOnce('aiAddInfoNotice', info, anchor);

    // 2) –ü–ª–∞—à–∫–∞ ‚Äú—É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥‚Äù ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –ø–æ –ø–∏—Å—å–º—É (flash –∏–∑ /auth)
    const emailFlash = (localStorage.getItem("AI_BIRZHA_LOGIN_FLASH") || "").trim();
    const ts = parseInt(localStorage.getItem("AI_BIRZHA_LOGIN_FLASH_TS") || "0", 10);
    const fresh = ts && (Date.now() - ts) < 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

    if(emailFlash && fresh){
      const ok = makeAlert('ok', `–í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –ø–æ–¥ –ª–æ–≥–∏–Ω–æ–º: <b>${emailFlash}</b>`);
      injectOnce('aiAddLoginNotice', ok, anchor);

      localStorage.removeItem("AI_BIRZHA_LOGIN_FLASH");
      localStorage.removeItem("AI_BIRZHA_LOGIN_FLASH_TS");
      return;
    }

    // 3) –ï—Å–ª–∏ flash –Ω–µ –ø—Ä–∏—à—ë–ª, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –º–æ–∂–Ω–æ —Ç–æ–∂–µ –ø–æ–∫–∞–∑–∞—Ç—å (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    const sb = await waitSb();
    if(!sb) return;

    const { data } = await sb.auth.getSession();
    const email = data?.session?.user?.email;
    if(email){
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ —Å–µ—Å—Å–∏—é –±—Ä–∞—É–∑–µ—Ä–∞
      if(!sessionStorage.getItem("AI_BIRZHA_ADD_SHOWN_AUTH")){
        const ok2 = makeAlert('ok', `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <b>${email}</b>`);
        injectOnce('aiAddLoginNotice', ok2, anchor);
        sessionStorage.setItem("AI_BIRZHA_ADD_SHOWN_AUTH", "1");
      }
    }
  });
})();
</script> <style>
  /* –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É..." —Å—Ä–∞–∑—É –ø–æ–¥ "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫" */
  #allrecords .ai-open-card-wrap{
    margin-top: 12px;
    width: 100%;
    flex-basis: 100%;
    display: flex;
    justify-content: flex-start;
  }
</style> <script>
(function(){
  async function waitSb(){
    for(let i=0;i<40;i++){
      if(window.AI_BIRZHA && window.AI_BIRZHA.sb) return window.AI_BIRZHA.sb;
      await new Promise(r => setTimeout(r,150));
    }
    return null;
  }

  function findRefreshBtn(){
    const els = Array.from(document.querySelectorAll('button, a, input[type="button"], input[type="submit"]'));
    return els.find(el => {
      const t = (el.textContent || el.value || "").trim().toLowerCase();
      return t === "–æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫";
    }) || null;
  }

  window.addEventListener('DOMContentLoaded', async () => {
    const sb = await waitSb();
    if(!sb) return;

    const { data: sess } = await sb.auth.getSession();
    const uid = sess?.session?.user?.id;
    if(!uid) return; // –Ω–µ –≤–æ—à—ë–ª ‚Äî –∫–Ω–æ–ø–∫—É –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º

    const wrap = document.createElement('div');
    wrap.className = 'ai-open-card-wrap';
    wrap.innerHTML = `<button class="btn primary" type="button" id="aiOpenMyCardBtn">–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –º–æ—é –∫–∞—Ä—Ç–æ—á–∫—É</button>`;

    const refreshBtn = findRefreshBtn();
    if(refreshBtn){
      // —Å—Ç–∞–≤–∏–º –ü–†–Ø–ú–û –ø–æ–¥ "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫"
      refreshBtn.insertAdjacentElement('afterend', wrap);
    }else{
      // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –≤ –∫–æ–Ω–µ—Ü –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      (document.querySelector('#allrecords') || document.body).appendChild(wrap);
    }

    document.getElementById('aiOpenMyCardBtn').addEventListener('click', async () => {
      const { data, error } = await sb
        .from("experts")
        .select("id,created_at")
        .eq("user_id", uid)
        .order("created_at", { ascending:false })
        .limit(1);

      if(error){
        alert("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏: " + error.message);
        return;
      }
      if(!data || !data.length){
        alert("–ö–∞—Ä—Ç–æ—á–∫–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.");
        return;
      }

      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
      const cardUrl = window.location.origin + "/page104196026.html?id=" + encodeURIComponent(data[0].id);
      window.open(cardUrl, "_blank");
    });
  });
})();
</script> <!-- ====== /add END ====== --> <!-- nominify end --> </div> </div> </div> </div> </div> <!--/allrecords--> <!-- Tilda copyright. Don't remove this line --><div class="t-tildalabel " id="tildacopy" data-tilda-sign="13172919#103811936"><a href="https://tilda.cc/" class="t-tildalabel__link"><div class="t-tildalabel__wrapper"><div class="t-tildalabel__txtleft">Made on </div><div class="t-tildalabel__wrapimg"><img src="https://static.tildacdn.com/img/tildacopy.png" class="t-tildalabel__img" fetchpriority="low" alt=""></div><div class="t-tildalabel__txtright">Tilda</div></div></a></div> <!-- Stat --> <script type="text/javascript">if(!window.mainTracker) {window.mainTracker='tilda';}
window.tildastatcookie='no';setTimeout(function(){(function(d,w,k,o,g) {var n=d.getElementsByTagName(o)[0],s=d.createElement(o),f=function(){n.parentNode.insertBefore(s,n);};s.type="text/javascript";s.async=true;s.key=k;s.id="tildastatscript";s.src=g;if(w.opera=="[object Opera]") {d.addEventListener("DOMContentLoaded",f,false);} else {f();}})(document,window,'b3e5db9cfc6c4460a026f51ee207b27b','script','https://static.tildacdn.com/js/tilda-stat-1.0.min.js');},2000);</script>

<!-- –†–æ—É—Ç–µ—Ä –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
<script>
(function() {
  const routes = {
    '/': 'index.html',
    '/services': 'page103809416.html',
    '/experts': 'page103811056.html',
    '/cases': 'page103811306.html',
    '/how': 'page103811576.html',
    '/faq': 'page103811816.html',
    '/apply': 'apply.html',
    '/add': 'add.html',
    '/auth': 'auth.html',
    '/privacy': 'page103812116.html',
    '/terms': 'page103812316.html',
    '/card': 'page104196026.html',
    '/video': 'page103813046.html',
    '/expert-template': 'page103813286.html',
    '/case-template': 'page103813646.html',
    '/bots': 'page103813746.html',
    '/design': 'page103813896.html',
    '/marketplaces': 'page103814106.html',
    '/sites': 'page103814276.html'
  };
  function handleLinkClick(e) {
    const link = e.target.closest('a');
    if (!link) return;
    const href = link.getAttribute('href');
    if (!href) return;
    if (href.startsWith('/') && !href.startsWith('//')) {
      e.preventDefault();
      e.stopPropagation();
      const path = href.split('?')[0].split('#')[0].replace(/\/$/, '') || '/';
      const file = routes[path];
      if (file) {
        const query = href.includes('?') ? href.substring(href.indexOf('?')) : '';
        const hash = href.includes('#') ? href.substring(href.indexOf('#')) : '';
        window.location.href = file + query + hash;
      } else {
        window.location.href = href;
      }
    }
  }
  document.addEventListener('click', handleLinkClick, true);
})();
</script>

</body> </html>